<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram News Post Generator</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
    
    <!-- BOX ICONS CSS -->
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Lucide Icons (Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Archivo+Black&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;700;900&family=Oswald:wght@500;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Poppins:wght@400;700;900&family=Roboto+Condensed:wght@400;700&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">


    <style>
        @import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap");

        /* Custom Scrollbar */
        .sidebar-scroll {
            direction: rtl; 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #e5e7eb transparent;
        }
        .sidebar-content {
            direction: ltr;
        }
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #d1d5db;
        }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #000;
            border: 2px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15), 0 0 0 0 rgba(0,0,0,0);
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25), 0 0 0 4px rgba(0,0,0,0.05);
        }
        input[type=range]::-webkit-slider-track {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
        }
        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #000;
            border: 2px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        input[type=range]::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }
        input[type=range]::-moz-range-track {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none; 
        }
        input[type=range]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(0,0,0,0.1), 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Hide scrollbar for body */
        body {
            overflow: hidden;
        }
        
        /* Custom Selection Color */
        ::selection {
            background: #d53478;
            color: #ffffff;
        }
        
        /* Smooth transitions */
        .transition-all-200 {
            transition: all 0.2s ease-out;
        }
        .transition-all-300 {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #ctx-toolbar.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

        /* Universal hover outline for all toolbarable elements */
        [data-ctx]:hover {
            outline: 2px dashed rgba(255, 255, 255, 0.5);
            outline-offset: 4px;
        }

        /* Ghost element style for "hidden" items */
        .ctx-ghost {
            opacity: 0 !important;
            pointer-events: auto !important;
            transition: opacity 0.2s ease;
        }

        .ctx-ghost:hover {
            opacity: 0.4 !important;
            outline: 2px dashed #d53478 !important; 
            outline-offset: 4px;
        }

        /* Deep linking highlight pulse */
        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 0 rgba(213, 52, 120, 0.7); border-color: #d53478; }
            70% { box-shadow: 0 0 0 10px rgba(213, 52, 120, 0); border-color: #b334a0; }
            100% { box-shadow: 0 0 0 0 rgba(213, 52, 120, 0); border-color: #d53478; }
        }

        .highlight-pulse {
            animation: highlightPulse 1.5s ease-out infinite;
            border: 2px dashed #d53478 !important;
            border-image: linear-gradient(45deg, #b334a0, #d53478) 1 !important;
            position: relative;
            z-index: 50;
        }

        /* Inline editing focus style */
        [contenteditable="true"]:focus {
            outline: 2px solid #d53478; 
            outline-offset: 4px;
            border-radius: 6px;
            /* background: rgba(0, 0, 0, 0.65); */
            background: rgba(20, 20, 20, 0.5); /* Semi-transparent dark bg */
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* Add shadow back for readability on light images */
            caret-color: #d53478;
            cursor: text;
            z-index: 100;
        }

        /* Force selection color to be pink everywhere */
        ::selection {
            background: #d53478 !important;
            color: #ffffff !important;
        }
        ::-moz-selection {
            background: #d53478 !important;
            color: #ffffff !important;
        }

        /* Hover hint for clickable text */
        [data-ctx="headline"]:hover, 
        [data-ctx="caption"]:hover, 
        [data-ctx="badge"]:hover, 
        [data-ctx="source"]:hover {
            outline: 1.5px dashed rgba(255, 255, 255, 0.35);
            outline-offset: 4px;
            border-radius: 6px;
            cursor: text;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Image loading state */
        .image-loading {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Better focus states */
        *:focus-visible {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        /* Smooth tab transitions */
        .tab-content {
            animation: fadeIn 0.2s ease-out;
        }

        /* Button hover effects */
        .btn-primary {
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Input focus states */
        input:focus, textarea:focus {
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }

        /* Color picker popover */
        .color-picker-popover {
            animation: fadeIn 0.15s ease-out;
        }

        /* Square checkbox with checkmark */
        .side-navbar input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #3e3e3e;
            border-radius: 4px;
            background-color: #2c2c2c;
            cursor: pointer;
            position: relative;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .side-navbar input[type="checkbox"]:hover {
            border-color: #4e4e4e;
            background-color: #323232;
        }

        .side-navbar input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #d53478 0%, #b334a0 100%);
            border-color: #d53478;
        }

        .side-navbar input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -60%) rotate(45deg);
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
        }

        /* Dark themed checkboxes */
        .side-navbar .bg-gray-50 input[type="checkbox"],
        .side-navbar .bg-white input[type="checkbox"] {
            border-color: #3e3e3e;
            background-color: #2c2c2c;
        }

        .side-navbar .bg-gray-50 input[type="checkbox"]:hover,
        .side-navbar .bg-white input[type="checkbox"]:hover {
            border-color: #4e4e4e;
            background-color: #323232;
        }

        .side-navbar .bg-gray-50 input[type="checkbox"]:checked,
        .side-navbar .bg-white input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #d53478 0%, #b334a0 100%);
            border-color: #d53478;
        }

        /* Export button loading state */
        .export-loading {
            pointer-events: none;
            opacity: 0.6;
        }

        /* ── Sidebar Panel ─────────────────────────────────── */
        .side-navbar {
            width: 364px; /* 280px * 1.3 = 364px */
            height: 100vh;
            position: fixed;
            margin-left: -364px;
            background-color: #282828;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            top: 0;
            left: 0;
            box-shadow: 6px 0 32px rgba(0,0,0,0.7);
            border-right: 1px solid rgba(255,255,255,0.06);
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            will-change: margin-left;
            color: #dddddd;
        }
        
        /* Mobile drag handle – hidden on desktop */
        .mobile-drag-handle {
            display: none;
        }

        @media (max-width: 768px) {

            /* ── Layout ───────────────────────────────────────── */
            body {
                flex-direction: column !important;
            }

            /* ── Bottom Sheet Panel ───────────────────────────── */
            .side-navbar {
                width: 100vw !important;
                height: 58vh !important;
                left: 0 !important;
                top: auto !important;
                bottom: 0 !important;
                margin-left: 0 !important;
                margin-bottom: -58vh !important;
                transition: margin-bottom 0.42s cubic-bezier(0.16, 1, 0.3, 1) !important;
                transform: none !important;
                /* No rounding here — toggle button provides the visual cap */
                border-radius: 0 !important;
                background: #282828 !important;
                box-shadow: 0 -6px 40px rgba(0,0,0,0.55) !important;
                border-right: none !important;
                border-top: none !important;
                will-change: margin-bottom;
            }

            .side-navbar.active-nav {
                margin-left: 0 !important;
                margin-bottom: 0 !important;
                z-index: 1001 !important;
            }

            .side-navbar > div {
                height: 58vh !important;
                padding-bottom: max(env(safe-area-inset-bottom, 8px), 8px) !important;
            }

            /* ── Mobile drag handle (inside panel top) ────────── */
            .mobile-drag-handle {
                display: flex !important;
                justify-content: center;
                align-items: center;
                padding: 10px 0 6px;
                flex-shrink: 0;
                cursor: pointer;
            }

            .drag-pill {
                width: 36px;
                height: 4px;
                background: rgba(255,255,255,0.18);
                border-radius: 2px;
                transition: background 0.2s, width 0.2s;
            }

            .mobile-drag-handle:hover .drag-pill,
            .mobile-drag-handle:active .drag-pill {
                background: rgba(255,255,255,0.35);
                width: 44px;
            }

            /* ── Main content area ────────────────────────────── */
            .my-container {
                flex: 1;
                margin-left: 0 !important;
                height: calc(100vh - 48px);
                min-height: calc(100vh - 48px);
                max-height: calc(100vh - 48px);
                transition: height 0.42s cubic-bezier(0.16, 1, 0.3, 1);
            }

            .my-container.active-cont {
                margin-left: 0;
                height: calc(42vh - 48px);
                min-height: calc(42vh - 48px);
                max-height: calc(42vh - 48px);
            }

            #preview-container {
                height: 100%;
                padding: 10px !important;
            }

            /* ── Toggle handle bar ────────────────────────────── */
            #menu-btn {
                display: none !important;
            }

            .mobile-toggle-button {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 5px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 48px;
                background: #282828;
                border-top: 1px solid rgba(255,255,255,0.07);
                border-radius: 20px 20px 0 0;
                color: #dddddd;
                cursor: pointer;
                transition: bottom 0.42s cubic-bezier(0.16, 1, 0.3, 1), background 0.15s ease;
                z-index: 1003;
                padding: 0;
            }

            body.sidebar-open .mobile-toggle-button {
                bottom: 58vh;
                border-radius: 0;
                border-top: 1px solid rgba(255,255,255,0.07);
            }

            .mobile-toggle-button:hover  { background: #323232; }
            .mobile-toggle-button:active { background: #3c3c3c; }

            .toggle-handle-pill {
                width: 34px;
                height: 3px;
                background: #dddddd;
                border-radius: 2px;
                transition: transform 0.3s ease, width 0.2s ease, background 0.2s ease;
            }

            body.sidebar-open .toggle-handle-pill {
                width: 46px;
                background: #dddddd;
                transform: rotate(180deg);
            }

            .toggle-handle-label {
                font-size: 9px;
                font-weight: 700;
                letter-spacing: 2px;
                text-transform: uppercase;
                color: #dddddd;
                transition: color 0.2s ease;
                font-family: Inter, -apple-system, sans-serif;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .toggle-handle-label i {
                font-size: 14px;
                transition: transform 0.3s ease;
            }

            body.sidebar-open .toggle-handle-label i {
                transform: rotate(180deg);
            }

            body.sidebar-open .toggle-handle-label {
                color: #dddddd;
            }

            /* ── Sidebar content — vertical scroll only ───────── */
            #sidebar-content {
                overflow-x: hidden !important;
                overflow-y: auto !important;
                width: 100%;
                -webkit-overflow-scrolling: touch;
            }

            .side-navbar [style*="overflow-y: auto"] {
                overflow-x: hidden !important;
            }

            /* Remove the ugly 1200px horizontal-scroll hack */
            .side-navbar .space-y-3,
            .side-navbar .space-y-4,
            .side-navbar .space-y-8,
            .side-navbar .space-y-3.animate-fade-in,
            .side-navbar .bg-gray-50.space-y-4,
            .side-navbar .bg-gray-50,
            .side-navbar .bg-white,
            .side-navbar .grid,
            .side-navbar .flex {
                min-width: unset !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* ── Navigation helpers ───────────────────────────── */
            .active-nav     { margin-left: 0 !important; }
            body.sidebar-open { overflow: hidden; }

            /* ── Top Navbar ───────────────────────────────────── */
            .top-navbar { padding: 6px 12px !important; }
            .top-navbar > div {
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
                gap: 8px !important;
            }
            .top-navbar #menu-btn            { display: none !important; }
            .top-navbar .mobile-logo-container { flex-shrink: 0; }
            .top-navbar .mode-buttons-container { margin-left: auto; flex-shrink: 0; }

            #mode-post-btn, #mode-highlight-btn {
                padding: 8px 10px !important;
                font-size: 10px !important;
                min-width: 90px !important;
                min-height: 28px !important;
            }

            /* ── Logos ────────────────────────────────────────── */
            .sidebar-logo-container { display: none !important; }
            .mobile-logo-container  { display: block !important; }
            
            /* Disable floating toolbar on mobile, but keep logic for inline editing */
            #ctx-toolbar { display: none !important; }
        }
        
        /* Desktop: Hide mobile toggle button */
        @media (min-width: 769px) {
            .mobile-toggle-button {
                display: none !important;
            }
        }

        .side-navbar .nav-link:active,
        .side-navbar .nav-link:focus,
        .side-navbar .nav-link:hover {
            background-color: #ffffff26;
        }

        .my-container {
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Desktop: Sidebar open state */
        .side-navbar.active-nav {
            margin-left: 0;
        }

        /* for main section */
        .active-cont {
            margin-left: 364px; /* Matches new sidebar width */
        }

        @media (max-width: 768px) {
            .active-cont {
                margin-left: 0;
            }
        }

        #menu-btn {
            background-color: #282828;
            color: #dddddd;
            margin-left: -52px;

            border: 1px solid rgba(255,255,255,0.07);
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        #menu-btn:hover {
            background-color: #323232;
            border-color: rgba(255,255,255,0.15);
            color: #ffffff;
        }

        #menu-btn i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .side-navbar.active-nav ~ .my-container #menu-btn i {
            transform: rotate(180deg);
        }

        .my-container input {
            border-radius: 2rem;
            padding: 2px 20px;
        }

        /* Sidebar scroll styling for dark theme */
        .side-navbar [style*="overflow-y: auto"] {
            scrollbar-width: thin;
            scrollbar-color: #ffffff26 transparent;
        }

        .side-navbar [style*="overflow-y: auto"]::-webkit-scrollbar {
            width: 6px;
        }

        .side-navbar [style*="overflow-y: auto"]::-webkit-scrollbar-track {
            background: transparent;
        }

        .side-navbar [style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
            background: #ffffff26;
            border-radius: 6px;
        }

        .side-navbar [style*="overflow-y: auto"]::-webkit-scrollbar-thumb:hover {
            background: #ffffff40;
        }

        /* Panel text colors in sidebar */
        .side-navbar label,
        .side-navbar .text-gray-500,
        .side-navbar .text-gray-400,
        .side-navbar .text-gray-600 {
            color: #dddddd !important;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .side-navbar .text-gray-900,
        .side-navbar .text-black {
            color: #dddddd !important;
        }

        /* Panel input fields */
        .side-navbar input[type="text"],
        .side-navbar input[type="number"],
        .side-navbar textarea,
        .side-navbar select {
            background-color: #3e3e3e !important;
            border: 1px solid #535353 !important;
            color: #dddddd !important;
            border-radius: 4px !important;
            padding: 8px 10px !important;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .side-navbar input[type="text"]:focus,
        .side-navbar input[type="number"]:focus,
        .side-navbar textarea:focus,
        .side-navbar select:focus {
            background-color: #3e3e3e !important;
            border-color: #d53478 !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 1px #d53478 !important;
            outline: none !important;
        }

        .side-navbar input[type="text"]::placeholder,
        .side-navbar textarea::placeholder {
            color: #9b9b9b !important;
        }

        /* Panel cards / containers */
        .side-navbar .bg-gray-50,
        .side-navbar .bg-gray-100 {
            background-color: #3e3e3e !important;
        }

        .side-navbar .border-gray-100,
        .side-navbar .border-gray-200 {
            border-color: #535353 !important;
        }

        /* Base button style inside cards / panel */
        .side-navbar button:not(.btn-light):not(#export-btn):not(.btn-accent):not(.color-picker-btn):not([aria-label*="color picker" i]) {
            background-color: #535353 !important;
            border: none !important;
            color: #dddddd !important;
            border-radius: 6px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            padding: 5px 10px !important;
            cursor: pointer !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        
        .side-navbar button:not(.btn-light):not(#export-btn):not(.btn-accent):not(.color-picker-btn):not([aria-label*="color picker" i]):hover {
            background-color: #5f5f5f !important;
            color: #ffffff !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
            transform: none !important;
        }
        
        .side-navbar button:not(.btn-light):not(#export-btn):not(.btn-accent):not(.color-picker-btn):not([aria-label*="color picker" i]):active {
            transform: none !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }

        .side-navbar .bg-white {
            background-color: #3e3e3e !important;
        }

        .side-navbar .text-black {
            color: #dddddd !important;
        }

        /* Ensure sidebar content is properly contained */
        .side-navbar #sidebar-content {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .side-navbar #sidebar-content * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix for form elements in sidebar */
        .side-navbar .space-y-3,
        .side-navbar .space-y-4,
        .side-navbar .space-y-8 {
            width: 100%;
        }

        .side-navbar input[type="text"],
        .side-navbar input[type="number"],
        .side-navbar textarea,
        .side-navbar select {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        .side-navbar .flex,
        .side-navbar .grid {
            width: 100% !important;
            max-width: 100% !important;
        }

        .side-navbar .gap-2,
        .side-navbar .gap-3,
        .side-navbar .gap-4 {
            width: 100%;
        }

        /* Ensure all content containers fit */
        .side-navbar div {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix for flex containers that might overflow */
        .side-navbar .flex-1 {
            min-width: 0;
            flex: 1 1 0%;
        }

        /* Ensure inputs in flex containers don't overflow */
        .side-navbar .flex input.flex-1 {
            min-width: 0;
            width: auto;
            flex: 1 1 0%;
        }

        /* Grid columns should fit */
        .side-navbar .grid-cols-2 > * {
            min-width: 0;
            max-width: 100%;
        }

        /* Ensure labels and text don't overflow */
        .side-navbar label,
        .side-navbar span,
        .side-navbar div {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Fix for space-y classes */
        .side-navbar .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
        .side-navbar .space-y-4 > * + * {
            margin-top: 1rem;
        }
        .side-navbar .space-y-8 > * + * {
            margin-top: 2rem;
        }

        /* Reduce spacing in sidebar for better fit */
        .side-navbar .space-y-8 {
            gap: 1.5rem;
        }

        /* Ensure proper padding in content areas */
        .side-navbar #sidebar-content > div {
            padding-left: 0;
            padding-right: 0;
        }

        /* Make sure buttons and inputs are properly sized */
        .side-navbar button:not(.btn-sm):not(.btn-light):not(#export-btn):not(.btn-accent) {
            padding: 5px 10px !important;
            font-size: 11px !important;
        }

        /* Better fit for grid layouts */
        .side-navbar .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
        }

        /* Base range slider styling in sidebar panel */
        .side-navbar input[type="range"] {
            width: 100% !important;
            margin: 8px 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
            height: 20px;
            cursor: pointer;
            padding: 0 !important;
            margin: 10px 0 !important;
        }

        /* Panel sliders – unified modern track (cards: #3e3e3e on panel bg #282828) */
        .side-navbar input[type="range"]::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #3e3e3e, #343434);
            border-radius: 999px;
            height: 4px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
        }

        .side-navbar input[type="range"]::-moz-range-track {
            background: linear-gradient(to right, #3e3e3e, #343434);
            border-radius: 999px;
            height: 4px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
        }

        /* Panel sliders – thumb – subtle accent, matches neutral UI */
        .side-navbar input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f3f3f3 40%, #d53478 100%);
            border: 2px solid #181818;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.6), 0 3px 8px rgba(0,0,0,0.4);
            margin-top: -5px; /* center on 4px track */
            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, background 0.12s ease-out;
        }

        .side-navbar input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f3f3f3 40%, #d53478 100%);
            border: 2px solid #181818;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.6), 0 3px 8px rgba(0,0,0,0.4);
            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, background 0.12s ease-out;
        }

        .side-navbar input[type="range"]:hover::-webkit-slider-thumb,
        .side-navbar input[type="range"]:focus-visible::-webkit-slider-thumb {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(213,52,120,0.45), 0 4px 10px rgba(0,0,0,0.6);
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #fde6f0 35%, #d53478 100%);
        }

        .side-navbar input[type="range"]:hover::-moz-range-thumb,
        .side-navbar input[type="range"]:focus-visible::-moz-range-thumb {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(213,52,120,0.45), 0 4px 10px rgba(0,0,0,0.6);
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #fde6f0 35%, #d53478 100%);
        }

        /* Ensure all sections are properly contained */
        .side-navbar .space-y-3 > *,
        .side-navbar .space-y-4 > *,
        .side-navbar .space-y-8 > * {
            width: 100%;
            max-width: 100%;
        }

        /* Fix for rounded containers */
        .side-navbar .rounded-lg {
            border-radius: 6px;
        }

        /* Ensure proper text sizing */
        .side-navbar .text-xs {
            font-size: 11px !important;
        }

        .side-navbar .text-\[10px\] {
            font-size: 10px !important;
        }

        .side-navbar .text-\[9px\] {
            font-size: 9px !important;
        }

        /* Fix padding for better fit */
        .side-navbar .p-2\.5,
        .side-navbar .p-4 {
            padding: 10px !important;
        }

        /* Adobe-style icons in sidebar */
        .side-navbar i:not(.bg-gray-50 i):not(.bg-white i),
        .side-navbar [data-lucide]:not(.bg-gray-50 [data-lucide]):not(.bg-white [data-lucide]) {
            color: #b8b8b8 !important;
        }
        
        .side-navbar button:hover i,
        .side-navbar button:hover [data-lucide] {
            color: #f5f5f5 !important;
        }
        
        /* Support Us button hover effect */
        .side-navbar a[href*="buymeacoffee"]:hover {
            opacity: 0.8;
        }
        
        /* Mobile toggle button - base styles (hidden by default, shown on mobile) */
        .mobile-toggle-button {
            display: none;
        }
        
        /* Mode buttons - ensure consistent sizing */
        #mode-post-btn, #mode-highlight-btn {
            min-width: 120px;
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Adobe-style cards in sidebar - maintain dark theme */
        .side-navbar .bg-gray-50:not(input):not(textarea):not(button),
        .side-navbar .bg-white:not(input):not(textarea):not(button) {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            box-shadow: none !important;
        }

        .side-navbar .bg-gray-50 .bg-gray-50,
        .side-navbar .bg-white .bg-gray-50 {
            background-color: #262626 !important;
        }

        /* Dark theme for inputs with bg-gray-50/bg-white class - must be very specific */
        .side-navbar #sidebar-content input[type="text"].bg-gray-50,
        .side-navbar #sidebar-content input[type="number"].bg-gray-50,
        .side-navbar #sidebar-content textarea.bg-gray-50,
        .side-navbar #sidebar-content input[type="text"].bg-white,
        .side-navbar #sidebar-content input[type="number"].bg-white,
        .side-navbar #sidebar-content textarea.bg-white,
        .side-navbar input[type="text"].bg-gray-50,
        .side-navbar input[type="number"].bg-gray-50,
        .side-navbar textarea.bg-gray-50,
        .side-navbar input[type="text"].bg-white,
        .side-navbar input[type="number"].bg-white,
        .side-navbar textarea.bg-white,
        .side-navbar .bg-gray-50 input[type="text"],
        .side-navbar .bg-gray-50 input[type="number"],
        .side-navbar .bg-gray-50 textarea,
        .side-navbar .bg-white input[type="text"],
        .side-navbar .bg-white input[type="number"],
        .side-navbar .bg-white textarea {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            color: #f5f5f5 !important;
            border-width: 1px !important;
            transition: all 0.2s ease !important;
        }

        .side-navbar #sidebar-content input[type="text"].bg-gray-50:focus,
        .side-navbar #sidebar-content input[type="number"].bg-gray-50:focus,
        .side-navbar #sidebar-content textarea.bg-gray-50:focus,
        .side-navbar #sidebar-content input[type="text"].bg-white:focus,
        .side-navbar #sidebar-content input[type="number"].bg-white:focus,
        .side-navbar #sidebar-content textarea.bg-white:focus,
        .side-navbar input[type="text"].bg-gray-50:focus,
        .side-navbar input[type="number"].bg-gray-50:focus,
        .side-navbar textarea.bg-gray-50:focus,
        .side-navbar input[type="text"].bg-white:focus,
        .side-navbar input[type="number"].bg-white:focus,
        .side-navbar textarea.bg-white:focus,
        .side-navbar .bg-gray-50 input[type="text"]:focus,
        .side-navbar .bg-gray-50 input[type="number"]:focus,
        .side-navbar .bg-gray-50 textarea:focus,
        .side-navbar .bg-white input[type="text"]:focus,
        .side-navbar .bg-white input[type="number"]:focus,
        .side-navbar .bg-white textarea:focus {
            background-color: #323232 !important;
            border-color: #d53478 !important;
            color: #f5f5f5 !important;
            box-shadow: 0 0 0 1px #d53478 !important;
            outline: none !important;
        }

        .side-navbar #sidebar-content input[type="text"].bg-gray-50::placeholder,
        .side-navbar #sidebar-content textarea.bg-gray-50::placeholder,
        .side-navbar #sidebar-content input[type="text"].bg-white::placeholder,
        .side-navbar #sidebar-content textarea.bg-white::placeholder,
        .side-navbar input[type="text"].bg-gray-50::placeholder,
        .side-navbar textarea.bg-gray-50::placeholder,
        .side-navbar input[type="text"].bg-white::placeholder,
        .side-navbar textarea.bg-white::placeholder,
        .side-navbar .bg-gray-50 input[type="text"]::placeholder,
        .side-navbar .bg-gray-50 textarea::placeholder,
        .side-navbar .bg-white input[type="text"]::placeholder,
        .side-navbar .bg-white textarea::placeholder {
            color: #9ca3af !important;
        }

        /* Light themed sliders in cards */
        .side-navbar .bg-gray-50 input[type="range"]::-webkit-slider-thumb,
        .side-navbar .bg-white input[type="range"]::-webkit-slider-thumb {
            background: #000000 !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(0, 0, 0, 0) !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]::-webkit-slider-thumb:hover,
        .side-navbar .bg-white input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15) !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(0, 0, 0, 0.05) !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]::-webkit-slider-track,
        .side-navbar .bg-white input[type="range"]::-webkit-slider-track {
            background: #e5e7eb !important;
            height: 4px !important;
            border-radius: 2px !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]::-moz-range-thumb,
        .side-navbar .bg-white input[type="range"]::-moz-range-thumb {
            background: #000000 !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]::-moz-range-thumb:hover,
        .side-navbar .bg-white input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15) !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25) !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]::-moz-range-track,
        .side-navbar .bg-white input[type="range"]::-moz-range-track {
            background: #e5e7eb !important;
            height: 4px !important;
            border-radius: 2px !important;
        }

        .side-navbar .bg-gray-50 input[type="range"]:focus::-webkit-slider-thumb,
        .side-navbar .bg-white input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
        }

        /* Dark themed buttons in cards */
        .side-navbar .bg-gray-50 button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.color-picker-btn):not(.btn-accent),
        .side-navbar .bg-white button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.color-picker-btn):not(.btn-accent) {
            background-color: #2c2c2c !important;
            border: none !important;
            color: #b8b8b8 !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        
        /* Ensure label buttons (like upload buttons) have visible text */
        .side-navbar .bg-gray-50 label.bg-gray-100,
        .side-navbar .bg-white label.bg-gray-100,
        .side-navbar label[aria-label*="Upload"],
        .side-navbar label.bg-gray-100 {
            color: #b8b8b8 !important;
        }
        
        /* Make sure all icons in buttons are visible */
        .side-navbar .bg-gray-50 button i,
        .side-navbar .bg-white button i,
        .side-navbar .bg-gray-50 label i,
        .side-navbar .bg-white label i {
            color: #b8b8b8 !important;
        }

        .side-navbar .bg-gray-50 button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.btn-accent):hover,
        .side-navbar .bg-white button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.btn-accent):hover {
            background-color: #3a3a3a !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            transform: none !important;
        }

        .side-navbar .bg-gray-50 button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.btn-accent):active,
        .side-navbar .bg-white button:not(.btn-light):not([class*="bg-black"]):not([class*="bg-white"]):not(.btn-accent):active {
            transform: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        /* Adobe-style card text colors */
        .side-navbar .bg-gray-50 .text-gray-400,
        .side-navbar .bg-gray-50 .text-gray-500,
        .side-navbar .bg-gray-50 .text-gray-600,
        .side-navbar .bg-white .text-gray-400,
        .side-navbar .bg-white .text-gray-500,
        .side-navbar .bg-white .text-gray-600 {
            color: #b8b8b8 !important;
        }

        .side-navbar .bg-gray-50 label,
        .side-navbar .bg-white label {
            color: #b8b8b8 !important;
        }

        /* Light themed borders in cards */
        .side-navbar .bg-gray-50 .border-gray-100,
        .side-navbar .bg-gray-50 .border-gray-200,
        .side-navbar .bg-white .border-gray-100,
        .side-navbar .bg-white .border-gray-200 {
            border-color: #e5e7eb !important;
        }

        /* Dark themed upload labels in cards */
        .side-navbar .bg-gray-50 label[aria-label*="Upload"],
        .side-navbar .bg-white label[aria-label*="Upload"] {
            background-color: #2c2c2c !important;
            color: #b8b8b8 !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
        }

        .side-navbar .bg-gray-50 label[aria-label*="Upload"]:hover,
        .side-navbar .bg-white label[aria-label*="Upload"]:hover {
            background-color: #3a3a3a !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            transform: none !important;
        }

        .side-navbar .bg-gray-50 label[aria-label*="Upload"]:active,
        .side-navbar .bg-white label[aria-label*="Upload"]:active {
            transform: scale(0.98) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
        }

        /* Preserve active/selected button states in cards */
        .side-navbar .bg-gray-50 button[class*="bg-black"],
        .side-navbar .bg-white button[class*="bg-black"] {
            background-color: #000000 !important;
            color: #ffffff !important;
            border-color: #000000 !important;
        }

        /* Light themed remove buttons */
        .side-navbar button.text-red-500,
        .side-navbar .text-red-500 {
            color: #dc2626 !important;
            background-color: transparent !important;
        }

        .side-navbar button.text-red-500:hover,
        .side-navbar .text-red-500:hover {
            color: #b91c1c !important;
        }

        /* Dark themed upload buttons (labels with bg-gray-100) */
        .side-navbar label.bg-gray-100[aria-label*="Upload"],
        .side-navbar label[aria-label*="Upload"].bg-gray-100,
        .side-navbar .bg-gray-50 label.bg-gray-100,
        .side-navbar .bg-white label.bg-gray-100 {
            background-color: #2c2c2c !important;
            color: #b8b8b8 !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
        }

        .side-navbar label.bg-gray-100[aria-label*="Upload"]:hover,
        .side-navbar label[aria-label*="Upload"].bg-gray-100:hover,
        .side-navbar .bg-gray-50 label.bg-gray-100:hover,
        .side-navbar .bg-white label.bg-gray-100:hover {
            background-color: #3a3a3a !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            transform: none !important;
        }

        .side-navbar label.bg-gray-100[aria-label*="Upload"]:active,
        .side-navbar label[aria-label*="Upload"].bg-gray-100:active,
        .side-navbar .bg-gray-50 label.bg-gray-100:active,
        .side-navbar .bg-white label.bg-gray-100:active {
            transform: scale(0.98) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
        }

        /* Dark themed editor design library buttons */
        .side-navbar button.bg-gray-100:not(.btn-accent),
        .side-navbar label.bg-gray-100.btn-primary:not(.btn-accent),
        .side-navbar button[class*="bg-gray-100"]:not(.btn-accent) {
            background-color: #2c2c2c !important;
            color: #b8b8b8 !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
        }

        .side-navbar button.bg-gray-100:hover:not(.btn-accent),
        .side-navbar label.bg-gray-100.btn-primary:hover:not(.btn-accent),
        .side-navbar button[class*="bg-gray-100"]:hover:not(.btn-accent) {
            background-color: #3a3a3a !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            transform: none !important;
        }

        /* Special accent buttons - Save preset and other primary actions */
        .side-navbar button.bg-black.btn-primary:not([class*="bg-white"]):not([class*="bg-gray"]),
        .side-navbar .btn-accent {
            background: linear-gradient(135deg, #d53478 0%, #b334a0 100%) !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 6px rgba(213,52,120,0.35) !important;
        }

        .side-navbar button.bg-black.btn-primary:hover:not([class*="bg-white"]):not([class*="bg-gray"]),
        .side-navbar .btn-accent:hover {
            background: linear-gradient(135deg, #e04488 0%, #c344b0 100%) !important;
            box-shadow: 0 2px 10px rgba(213,52,120,0.45) !important;
            transform: none !important;
        }

        /* Dark themed preset card buttons (load/delete) */
        .side-navbar button.hover\:bg-gray-100,
        .side-navbar button[class*="hover:bg-gray-100"] {
            background-color: transparent !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button.hover\:bg-gray-100:hover,
        .side-navbar button[class*="hover:bg-gray-100"]:hover {
            background-color: #3a3a3a !important;
            color: #f5f5f5 !important;
        }

        .side-navbar button.hover\:bg-red-50,
        .side-navbar button[class*="hover:bg-red-50"] {
            background-color: transparent !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button.hover\:bg-red-50:hover,
        .side-navbar button[class*="hover:bg-red-50"]:hover {
            background-color: #4a2c2c !important;
            color: #ff6b6b !important;
        }

        /* Dark themed preset cards */
        .side-navbar .bg-white.p-3.rounded-lg.border,
        .side-navbar div[class*="bg-white"][class*="p-3"][class*="rounded-lg"] {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
        }

        .side-navbar .bg-white.p-3.rounded-lg.border:hover,
        .side-navbar div[class*="bg-white"][class*="p-3"][class*="rounded-lg"]:hover {
            border-color: #4e4e4e !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4) !important;
        }

        /* Dark themed text in preset cards */
        .side-navbar .bg-white .text-gray-700,
        .side-navbar .bg-white .text-gray-400 {
            color: #b8b8b8 !important;
        }

        .side-navbar .bg-white .text-gray-400 {
            color: #8b8b8b !important;
        }

        /* Light themed icons in buttons */
        .side-navbar button i,
        .side-navbar label i,
        .side-navbar button [data-lucide],
        .side-navbar label [data-lucide] {
            color: inherit !important;
        }

        /* Dark themed empty state messages */
        .side-navbar .border-dashed.border-gray-200 {
            border-color: #3e3e3e !important;
            color: #8b8b8b !important;
            background-color: #2c2c2c !important;
        }

        /* Dark themed font selection buttons in design tab */
        .side-navbar button.bg-gray-50.border-gray-200,
        .side-navbar button[class*="bg-gray-50"][class*="border-gray-200"] {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button.bg-gray-50.border-gray-200:hover,
        .side-navbar button[class*="bg-gray-50"][class*="border-gray-200"]:hover {
            background-color: #3a3a3a !important;
            border-color: #4e4e4e !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
        }

        /* Ensure all buttons with bg-gray-100 get dark theme */
        .side-navbar button[class*="bg-gray-100"],
        .side-navbar label[class*="bg-gray-100"] {
            background-color: #2c2c2c !important;
        }

        .side-navbar button[class*="bg-gray-100"]:hover,
        .side-navbar label[class*="bg-gray-100"]:hover {
            background-color: #3a3a3a !important;
        }

        /* ── Sidebar Tab Buttons ──────────────────────────── */
        .side-navbar #tabs-container button {
            padding: 5px 10px !important;
            border-radius: 6px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            background: transparent !important;
            color: rgba(255,255,255,0.4) !important;
            border: none !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
            letter-spacing: 0.2px !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            transform: none !important;
        }

        .side-navbar #tabs-container button:hover {
            background: rgba(255,255,255,0.1) !important;
            color: rgba(255,255,255,0.9) !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
            transform: none !important;
        }

        .side-navbar #tabs-container button[aria-selected="true"] {
            background: rgba(255,255,255,0.15) !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            box-shadow: 0 1px 6px rgba(0,0,0,0.3) !important;
        }

        .side-navbar #tabs-container button[aria-selected="true"]:hover {
            background: rgba(255,255,255,0.2) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.35) !important;
        }

        /* ── Export Button ────────────────────────────────── */
        #export-btn {
            background: linear-gradient(135deg, #d53478 0%, #b334a0 100%) !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.15s ease !important;
            flex-shrink: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            transform: none !important;
            box-shadow: 0 1px 6px rgba(213,52,120,0.35) !important;
        }

        #export-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #e04488 0%, #c344b0 100%) !important;
            transform: none !important;
            box-shadow: 0 2px 10px rgba(213,52,120,0.45) !important;
        }

        #export-btn:disabled {
            opacity: 0.45 !important;
            cursor: not-allowed !important;
        }

        /* Light themed source button (showSource toggle) */
        .side-navbar button[aria-label*="source" i],
        .side-navbar button[onclick*="showSource"] {
            background-color: #ffffff !important;
            border: none !important;
            color: #6b7280 !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        .side-navbar button[aria-label*="source" i]:hover,
        .side-navbar button[onclick*="showSource"]:hover {
            background-color: #f3f4f6 !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
            transform: none !important;
        }

        .side-navbar button[aria-label*="source" i].bg-black,
        .side-navbar button[onclick*="showSource"].bg-black {
            background-color: #2c2c2c !important;
            color: #ffffff !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            transition: all 0.15s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            letter-spacing: 0.2px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        
        .side-navbar button[aria-label*="source" i].bg-black:hover,
        .side-navbar button[onclick*="showSource"].bg-black:hover {
            background-color: #3a3a3a !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        }

        /* Dark themed color picker buttons */
        .side-navbar button[aria-label*="color picker" i],
        .side-navbar button[onclick*="classList.toggle"][class*="bg-white"] {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button[aria-label*="color picker" i]:hover,
        .side-navbar button[onclick*="classList.toggle"][class*="bg-white"]:hover {
            background-color: #3a3a3a !important;
            border-color: #4e4e4e !important;
        }

        .side-navbar button[aria-label*="color picker" i] .text-gray-600,
        .side-navbar button[onclick*="classList.toggle"][class*="bg-white"] .text-gray-600 {
            color: #b8b8b8 !important;
        }

        .side-navbar button[aria-label*="color picker" i]:hover .text-gray-600,
        .side-navbar button[onclick*="classList.toggle"][class*="bg-white"]:hover .text-gray-600 {
            color: #f5f5f5 !important;
        }

        /* Dark themed color picker popover */
        .side-navbar .color-picker-popover {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
        }

        .side-navbar .color-picker-popover button {
            border-color: #3e3e3e !important;
        }

        /* Ensure color picker buttons show their background colors - preserve inline styles */
        .side-navbar .color-picker-popover button.color-picker-btn {
            background-color: var(--btn-bg-color) !important;
        }

        /* Exclude color picker buttons from other button style overrides - use inline style directly */
        .side-navbar button.color-picker-btn[style*="background-color"] {
            background-color: var(--btn-bg-color) !important;
        }

        /* Force color picker buttons to use their inline style background */
        .side-navbar .color-picker-popover .grid button.color-picker-btn {
            background-color: var(--btn-bg-color) !important;
        }

        .side-navbar .color-picker-popover input[type="color"] {
            border-color: #3e3e3e !important;
        }

        /* Dark themed icon source buttons (Gallery/Upload) */
        .side-navbar button[aria-label*="icon" i][class*="bg-white"],
        .side-navbar label[aria-label*="icon" i][class*="bg-white"],
        .side-navbar button[aria-label*="gallery" i],
        .side-navbar label[aria-label*="upload" i][class*="custom"] {
            background-color: #2c2c2c !important;
            border-color: #3e3e3e !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button[aria-label*="icon" i][class*="bg-white"]:hover,
        .side-navbar label[aria-label*="icon" i][class*="bg-white"]:hover,
        .side-navbar button[aria-label*="gallery" i]:hover,
        .side-navbar label[aria-label*="upload" i][class*="custom"]:hover {
            background-color: #3a3a3a !important;
            border-color: #4e4e4e !important;
        }

        .side-navbar button[aria-label*="icon" i].bg-black,
        .side-navbar label[aria-label*="icon" i].bg-black,
        .side-navbar button[aria-label*="gallery" i].bg-black,
        .side-navbar label[aria-label*="upload" i][class*="custom"].bg-black {
            background-color: #000000 !important;
            color: #ffffff !important;
            border-color: #000000 !important;
        }

        /* Dark themed icon gallery buttons */
        .side-navbar button[aria-label*="Select" i][class*="icon"][class*="bg-gray-100"],
        .side-navbar button[class*="bg-gray-100"][class*="text-gray-500"] {
            background-color: #2c2c2c !important;
            color: #b8b8b8 !important;
        }

        .side-navbar button[aria-label*="Select" i][class*="icon"][class*="bg-gray-100"]:hover,
        .side-navbar button[class*="bg-gray-100"][class*="text-gray-500"]:hover {
            background-color: #3a3a3a !important;
            color: #f5f5f5 !important;
        }

        .side-navbar button[aria-label*="Select" i][class*="icon"].bg-black,
        .side-navbar button[class*="bg-black"][class*="text-white"][class*="shadow-md"] {
            background-color: #000000 !important;
            color: #ffffff !important;
        }

        /* Ensure Lucide icons are visible - don't hide until fully initialized */
        .side-navbar [data-lucide] {
            opacity: 1;
            pointer-events: auto;
            min-width: 1em;
            min-height: 1em;
        }
        
        .side-navbar [data-lucide] svg {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Only hide truly empty icons after a delay */
        .side-navbar [data-lucide]:not(:has(svg)):not(:has(*)) {
            opacity: 0.3;
        }

        /* Hide icon buttons that have no visible SVG content */
        .side-navbar .icon-gallery-btn {
            position: relative;
        }

        .side-navbar .icon-gallery-btn svg {
            display: block !important;
            width: 16px !important;
            height: 16px !important;
            color: inherit !important;
        }
        
        /* Ensure Lucide icons are visible in gallery */
        .side-navbar .icon-gallery-btn [data-lucide] svg {
            display: block !important;
            width: 16px !important;
            height: 16px !important;
            stroke: currentColor !important;
            fill: none !important;
        }
        
        /* Make sure icon containers are visible */
        .side-navbar .icon-gallery-btn .icon-lucide {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
        }

        .side-navbar .icon-gallery-btn:has(svg[width="0"]),
        .side-navbar .icon-gallery-btn:has(svg[height="0"]) {
            display: none !important;
        }

        /* After icons are created, hide any that are blank */
        .side-navbar .icon-gallery-btn:has([data-lucide] svg[viewBox=""]) {
            display: none !important;
        }

        /* Canvas icon styling - ensure icons are visible */
        #canvas-root [data-lucide] {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #canvas-root [data-lucide] svg {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            stroke: currentColor !important;
            fill: none !important;
        }

        /* ── Contextual Floating Toolbar ─────────────────────── */
        #ctx-toolbar {
            position: fixed;        /* body-level: never clipped by containers */
            z-index: 99999;         /* highest possible – above navbar, sidebar, overlays */
            display: none;
            background: #282828;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.4);
            padding: 8px;
            align-items: center;
            gap: 8px;
            font-family: Inter, -apple-system, sans-serif;
            pointer-events: auto;
            white-space: nowrap;
            /* transform: translateX(-50%); removed – left is now computed precisely */
            animation: fadeIn 0.15s ease-out;
            
            /* Responsive Sizing */
            max-width: 94vw;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        #ctx-toolbar::-webkit-scrollbar { display: none; }

        #ctx-toolbar.visible { display: flex; }

        /* Arrow pointing down */
        #ctx-toolbar::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 6px;
            background: #282828;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            border-top: 1px solid rgba(255,255,255,0.05); /* subtle detail */
        }

        #ctx-toolbar .ctx-sep {
            width: 1px; height: 20px;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
            margin: 0 2px;
        }
        /* Never show divider as first item */
        #ctx-toolbar .ctx-sep:first-child { display: none; }
        
        #ctx-toolbar .ctx-label {
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; color: #dddddd;
            letter-spacing: .5px; flex-shrink: 0;
            margin-right: 2px;
        }
        
        /* color swatch */
        #ctx-toolbar .ctx-swatch {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: transform .15s, border-color .15s;
            flex-shrink: 0; outline: none;
        }
        #ctx-toolbar .ctx-swatch:hover { transform: scale(1.15); border-color: rgba(255,255,255,0.8); }
        #ctx-toolbar .ctx-swatch.ctx-swatch-active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 0 2px rgba(255,255,255,0.2); }

        /* compact slider */
        #ctx-toolbar .ctx-slider {
            width: 80px; cursor: pointer;
            -webkit-appearance: none; appearance: none;
            height: 4px; border-radius: 99px;
            background: linear-gradient(to right, #3e3e3e, #343434);
            outline: none;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
            padding: 0; margin: 0;
        }
        #ctx-toolbar .ctx-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f3f3f3 40%, #d53478 100%);
            border: 2px solid #181818;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
            margin-top: -5px; /* center on 4px track */
            transition: transform 0.1s;
        }
        #ctx-toolbar .ctx-slider::-moz-range-thumb {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f3f3f3 40%, #d53478 100%);
            border: 2px solid #181818;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }
        #ctx-toolbar .ctx-slider:hover::-webkit-slider-thumb { transform: scale(1.1); }

        /* small icon/text button - MATCHING SIDEBAR AESTHETIC */
        #ctx-toolbar .ctx-btn {
            background-color: #535353;
            border: 1px solid transparent; 
            border-radius: 6px;
            color: #dddddd; 
            padding: 6px 10px;
            font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.15s ease;
            display: inline-flex; align-items: center; gap: 4px;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            letter-spacing: 0.2px;
        }
        #ctx-toolbar .ctx-btn:hover { 
            background-color: #5f5f5f; 
            color: #ffffff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transform: translateY(-0.5px);
        }
        #ctx-toolbar .ctx-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #ctx-toolbar .ctx-btn.active { 
            background: linear-gradient(135deg, #d53478 0%, #b334a0 100%); 
            color: #fff; 
            box-shadow: 0 1px 5px rgba(213,52,120,0.4);
        }

        /* value display */
        #ctx-toolbar .ctx-val {
            font-size: 10px; font-weight: 700; color: #bbb;
            min-width: 28px; text-align: center; flex-shrink: 0;
            font-family: 'JetBrains Mono', monospace;
        }

        /* hidden color input trick */
        #ctx-toolbar .ctx-color-wrap { position: relative; display: inline-flex; }
        #ctx-toolbar .ctx-color-wrap input[type="color"] {
            position: absolute; opacity: 0;
            width: 100%; height: 100%; cursor: pointer;
            inset: 0; border: none; padding: 0; margin: 0;
        }

        /* inline text editor */
        #ctx-toolbar .ctx-text-input {
            background: #3e3e3e;
            border: 1px solid #535353;
            border-radius: 6px;
            color: #fff;
            font-size: 11px;
            font-weight: 500;
            padding: 5px 8px;
            outline: none;
            width: 160px;
            font-family: Inter, sans-serif;
            transition: border-color .15s;
        }
        #ctx-toolbar .ctx-text-input:focus {
            border-color: #d53478;
            box-shadow: 0 0 0 1px #d53478;
        }
        #ctx-toolbar .ctx-text-input.wide { width: 220px; }

        /* image replace area */
        #ctx-toolbar .ctx-img-label {
            background-color: #535353;
            border: 1px solid transparent; /* No dashed border to match buttons */
            border-radius: 6px;
            color: #dddddd;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all .15s;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #ctx-toolbar .ctx-img-label:hover { 
            background-color: #5f5f5f; 
            color: #ffffff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* Loader Styles */
        #initial-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #131314;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .loader {
            position: relative;
            width: 50px;
            height: 50px;
            background: linear-gradient(
                #ec7258,
                #d53478,
                #b334a0
            );
            border-radius: 50%;
            animation: rotate 1s ease infinite;
        }

        .loader::before {
            content: "";
            position: absolute;
            width: 40px;
            height: 40px;
            background: #131314;
            border-radius: 50%;
            top: 5px;
            left: 5px;
        }

        @keyframes rotate {
            100% {
                transform: rotate(1turn);
            }
        }

        /* Welcome Popup Styles */
        #welcome-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 9998;
            
            /* User's body styles */
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            font-family: "Source Sans Pro", sans-serif;
            justify-content: center;
            margin: 0;
            
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #welcome-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        #welcome-popup-overlay .card {
            align-items: center;
            background-color: #282828;
            border-radius: 20px;
            box-shadow: 0 0.4px 3.6px rgba(0, 0, 0, 0.004),
                0 1px 8.5px rgba(0, 0, 0, 0.01), 0 1.9px 15.7px rgba(0, 0, 0, 0.019),
                0 3.4px 28.2px rgba(0, 0, 0, 0.03), 0 6.3px 54.4px rgba(0, 0, 0, 0.047),
                0 15px 137px rgba(0, 0, 0, 0.07);
            display: flex;
            flex-direction: column;
            position: relative;
            width: 353px;
            padding-top: 24px;
            border: none; /* Override Bootstrap */
        }

        #welcome-popup-overlay .text {
            box-sizing: border-box;
            padding: 0 20px 20px;
            width: 100%;
        }

        #welcome-popup-overlay .title {
            align-items: center;
            color: #ffffff;
            display: flex;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
        }

        #welcome-popup-overlay .tooltip {
            font-size: 16px;
            font-weight: normal;
            margin-top: 2px;
            position: relative;
        }

        #welcome-popup-overlay .tooltip:hover {
            cursor: help;
        }

        #welcome-popup-overlay .tooltip-spacing {
            height: 20px;
            margin: 8px;
            position: relative;
            width: 20px;
        }

        #welcome-popup-overlay .tooltip-bg1 {
            background-color: #ffffff;
            border-radius: 10px;
            content: " ";
            display: flex;
            height: 20px;
            position: absolute;
            top: 0;
            width: 20px;
        }

        #welcome-popup-overlay .tooltip-bg2 {
            background-color: #282828;
            border-radius: 8px;
            content: " ";
            display: flex;
            height: 16px;
            left: 2px;
            position: absolute;
            top: 2px;
            width: 16px;
        }

        #welcome-popup-overlay .tooltip-text {
            color: #ffffff;
            font-size: 14px;
            font-weight: bold;
            line-height: 20px;
            position: relative;
            text-align: center;
            width: 20px;
        }

        #welcome-popup-overlay .info {
            color: #dddddd;
            line-height: 1.4;
        }

        #welcome-popup-overlay .popup-bg {
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.16))
                drop-shadow(0 3px 6px rgba(0, 0, 0, 0.23));
            position: absolute;
            top: -126px;
            opacity: 0;
            transition: opacity 240ms 120ms cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        #welcome-popup-overlay .popup-outline {
            position: absolute;
            top: -126px;
            pointer-events: none;
        }

        #welcome-popup-overlay .popup-text {
            border-radius: 12px;
            box-sizing: border-box;
            color: #fff;
            font-size: 16px;
            font-weight: normal;
            left: 8px;
            opacity: 0;
            padding: 12px 16px;
            position: absolute;
            top: -117px;
            transition: opacity 240ms 120ms cubic-bezier(0.4, 0, 0.2, 1);
            width: 307px;
            pointer-events: none;
        }

        #welcome-popup-overlay .popup-outline-left {
            stroke-dasharray: 0 426px;
            stroke-dashoffset: 1px;
            transition: stroke-dasharray 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        #welcome-popup-overlay .popup-outline-right {
            stroke-dasharray: 352px 352px;
            stroke-dashoffset: -352px;
            transition: stroke-dashoffset 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hover Interactions */
        #welcome-popup-overlay .tooltip:hover ~ .popup-text {
            display: block;
            opacity: 1;
        }

        #welcome-popup-overlay .tooltip:hover ~ .popup-bg {
            opacity: 1;
            transition: opacity 240ms 120ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        #welcome-popup-overlay .tooltip:hover ~ .popup-outline .popup-outline-left {
            stroke-dasharray: 426px 426px;
            transition: stroke-dasharray 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        #welcome-popup-overlay .tooltip:hover ~ .popup-outline .popup-outline-right {
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        #welcome-popup-overlay .buttons {
            display: flex;
            margin-top: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        #welcome-popup-overlay .button {
            align-items: center;
            background: #535353;
            color: #dddddd;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            height: 50px;
            justify-content: center;
            margin: 0 5px 28px 20px;
            width: 100%;
            font-weight: bold;
            transition: background 0.2s, filter 0.2s;
        }

        #welcome-popup-overlay .button:hover {
            background: #666666;
        }

        #welcome-popup-overlay .button:last-child {
            margin: 0 20px 28px 5px;
        }

        #welcome-popup-overlay .button-primary {
            background: linear-gradient(to right, #d53478, #b334a0);
            color: #fcf5f9;
        }

        #welcome-popup-overlay .button-primary:hover {
            filter: brightness(1.1);
            background: linear-gradient(to right, #d53478, #b334a0);
        }
    </style>
</head>
    <body class="bg-[#131314] text-gray-900 font-sans flex flex-col h-screen overflow-hidden selection:bg-black selection:text-white">
    
    <!-- Initial Loader -->
    <div id="initial-loader">
        <div class="loader"></div>
    </div>

    <!-- Welcome Popup -->
    <div id="welcome-popup-overlay">
        <div class="card">
            <div class="text">
                <div class="title">
                    Welcome
                    <div class="tooltip">
                        <div class="tooltip-spacing">
                            <div class="tooltip-bg1"></div>
                            <div class="tooltip-bg2"></div>
                            <div class="tooltip-text">?</div>
                        </div>
                    </div>

                    <!-- Tooltip Popup Backgrounds and Text -->
                    <svg class="popup-bg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 130" height="130" width="315" preserveAspectRatio="none">
                        <path d="M36.5 12.695c15.9-2.4 32.556-4.284 82.977-3.815 79.67.74 121.785.26 145.294 5.51 18.483 4.13 34.333 11.696 33.382 32.11l-1.696 36.39c-1.01 21.68-11.678 29.377-21.934 30.838-14.884 2.12-29.72 3.52-54.512-.848C232.522 118.263 233.5 129 233.5 129s-1.992-7.686-32.218-14c-17.933-5.043-118.204 3.687-163.51-2.544-21.317-2.932-33.706-8.26-34.228-27.022L2.272 39.717c-.46-16.58 12.34-23.718 34.23-27.022z" fill="#303030" stroke="#000" />
                    </svg>
                    <svg class="popup-outline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 130" height="130" width="315" preserveAspectRatio="none">
                        <g stroke-width="2" stroke-linecap="round">
                            <path class="popup-outline-left" d="M233.5 129s-1.992-7.686-32.218-14c-17.933-5.043-118.204 3.687-163.51-2.544-21.317-2.932-33.706-8.26-34.228-27.022L2.272 39.717c-.46-16.58 12.34-23.718 34.23-27.022 15.897-2.4 32.554-4.284 82.975-3.815" fill="none" stroke="#303030" />
                            <path class="popup-outline-right" d="M119.477 8.88c79.67.74 121.785.26 145.294 5.51 18.483 4.13 34.333 11.696 33.382 32.11l-1.696 36.39c-1.01 21.68-11.678 29.377-21.934 30.838-14.884 2.12-29.72 3.52-54.512-.848C232.522 118.263 233.5 129 233.5 129" fill="none" stroke="#303030" />
                        </g>
                    </svg>
                    <div class="popup-text">
                        We prioritize your privacy. All image processing is performed locally on your device. No data is uploaded to any server.
                    </div>
                </div>

                <div class="info">
                    Instatools is a professional design suite for Instagram content creation. Access advanced layout tools, typography controls, and high-resolution export options to elevate your visual identity.
                </div>
            </div>

            <div class="buttons">
                <div class="button" onclick="closeWelcomePopup()">Dismiss</div>
                <div class="button button-primary" onclick="closeWelcomePopup()">Start Creating</div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            // Initial Loader Logic
            setTimeout(function() {
                var loader = document.getElementById('initial-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                    setTimeout(function() {
                        loader.remove();
                        
                        // Check for welcome popup after loader is gone
                        checkWelcomePopup();
                    }, 500); // Wait for transition to finish
                } else {
                    checkWelcomePopup();
                }
            }, 3000); // Show for 3 seconds
        });

        function checkWelcomePopup() {
            if (!localStorage.getItem('hasSeenWelcome')) {
                var popup = document.getElementById('welcome-popup-overlay');
                if (popup) {
                    popup.classList.add('show');
                }
            }
        }

        function closeWelcomePopup() {
            var popup = document.getElementById('welcome-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(function() {
                    popup.remove();
                }, 500);
            }
            localStorage.setItem('hasSeenWelcome', 'true');
        }
    </script>

    <!-- Mobile Handle Bar (full-width, always visible on mobile) -->
    <button id="mobile-toggle-btn" class="mobile-toggle-button" onclick="toggleMobileSidebar()" aria-label="Toggle panel">
        <div class="toggle-handle-pill"></div>
        <span class="toggle-handle-label">Tools</span>
    </button>

    <!-- Side-Nav / Mobile Bottom Sheet -->
    <div class="side-navbar" id="sidebar">
        <div style="display: flex; flex-direction: column; height: 100vh; overflow: hidden;">

            <!-- Desktop logo header -->
            <div style="flex-shrink: 0; padding: 18px 16px 16px; border-bottom: 1px solid rgba(255,255,255,0.07);" class="sidebar-logo-container">
                <img src="src/ui/logo.png" alt="Instagram Post Generator" style="max-width: 100%; height: auto; display: block; margin-left: -3px;">
            </div>

            <!-- Tabs + Export row -->
            <div style="flex-shrink: 0; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.07);">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div id="tabs-container" style="display: flex; gap: 3px; flex: 1; align-items: center;">
                        <!-- Tabs injected by JS -->
                    </div>
                    <button id="export-btn" onclick="exportCanvas()" aria-label="Export canvas">
                        <i class="bx bx-download" style="font-size: 13px;"></i>
                        <span id="export-text">Export</span>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                <div id="sidebar-content" class="tab-content" style="padding: 14px; padding-bottom: 24px;">
                    <!-- Dynamic controls injected by JS -->
                </div>
            </div>

            <!-- Footer -->
            <div style="flex-shrink: 0; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.07); text-align: center;">
                <a href="https://buymeacoffee.com/galore" target="_blank" rel="noopener noreferrer" style="text-decoration: none; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.45); display: inline-flex; align-items: center; gap: 5px; transition: color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.75)'" onmouseout="this.style.color='rgba(255,255,255,0.45)'">
                    Buy Me A Coffee <i class="bx bx-heart" style="color: #ffffff; font-size: 13px; transform: translateY(-1px);"></i>
                </a>
            </div>

        </div>
    </div>

    <!-- Main Wrapper -->
    <div class="p-1 my-container flex-1 flex flex-col h-full overflow-hidden">
        <!-- Top Nav -->
        <nav class="navbar top-navbar navbar-light bg-[#131314] px-5 flex-shrink-0 border-b border-neutral-800">
            <div class="flex items-center justify-between w-full">
                <!-- Mobile Logo (Left side) -->
                <div class="mobile-logo-container" style="display: none;">
                    <img src="src/ui/logo.png" alt="Instagram Post Generator" style="height: 32px; width: auto; display: block;">
                </div>
                <!-- Desktop Menu Button -->
                <a class="btn border-0" id="menu-btn" title="Toggle Sidebar"><i class="bx bx-chevron-right"></i></a>
                <!-- Mode Buttons (Right side on mobile) -->
                <div class="flex bg-black p-1 rounded-lg gap-1 mode-buttons-container">
                    <button id="mode-post-btn" class="px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 bg-white text-black shadow-sm hover:shadow-md" onclick="setMode('post')" aria-label="Post Generator Mode" style="min-width: 120px; min-height: 32px;">Post Generator</button>
                    <button id="mode-highlight-btn" class="px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 text-gray-400 hover:text-gray-300" onclick="setMode('highlight')" aria-label="Highlight Creator Mode" style="min-width: 120px; min-height: 32px;">Highlight Creator</button>
                </div>
            </div>
        </nav>

        <!-- PREVIEW AREA -->
        <div id="preview-container" class="flex-1 bg-[#131314] flex items-center justify-center p-8 overflow-hidden h-full relative">
            <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <!-- Scale Wrapper -->
            <div id="scale-wrapper" class="relative transition-all-300 ease-out shadow-2xl">
                <!-- CANVAS CONTENT (POST or HIGHLIGHT) -->
                <div id="canvas-root" class="relative bg-black overflow-hidden flex flex-col font-sans">
                    <!-- Content injected by JS -->
                </div>
            </div>

            <!-- Contextual Floating Toolbar moved to body level -->

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-sm font-medium text-gray-700">Exporting...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden File Input -->
    <input type="file" id="global-file-input" class="hidden" accept="image/*">

    <!-- Contextual Floating Toolbar (body-level so it is never clipped by overflow:hidden containers) -->
    <div id="ctx-toolbar" role="toolbar" aria-label="Element quick controls"></div>

    <!-- Javascript Logic -->
    <script>
        // --- STATE MANAGEMENT ---
        const PRESETS_KEY = "ig_news_gen_presets_vanilla_v1";
        const NOISE_SVG = `data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E`;

        const state = {
            mode: 'post', // 'post' | 'highlight'
            activeTab: 'editor',
            isExporting: false,
            
            // Post State
            post: {
                template: 'template1', // 'template1' | 'template2' | 'template3'
                headline: "OBAMA CLAIMS [ALIENS] ARE {REAL}",
                caption: "He also denied that they're being held at Area 51",
                bgImage: "https://raw.githubusercontent.com/nicholasxdavis/ptm/main/holder/obama.webp",

                // Template 2 state (simple: white top bar, image below, watermark BL)
                t2: {
                    headline: "Donald Trump Says 'I Don't Like Young Handsome Men'",
                    bgImage: "https://dims.apnews.com/dims4/default/ecd7c9e/2147483647/strip/true/crop/2993x1995+0+0/resize/1020x680!/quality/90/?url=https%3A%2F%2Fassets.apnews.com%2F2e%2F49%2F3567936f86ceb8625b25f35d975d%2Fff97e8a599a442ba8d7016a4b29f03c4",
                    fontFamily: 'DM Sans',
                    fontSize: 67,
                    watermarkUrl: 'https://cdn.shopify.com/s/files/1/0114/9403/1418/files/nj_logo_300x_300_1.png?v=1602025721',
                    watermarkSize: 201,
                    watermarkOpacity: 0.61,
                    showWatermark: true,
                    watermarkPosX: 3,
                    watermarkPosY: 99,
                    imagePosX: 50,
                    imagePosY: 50,
                    imageScale: 100,
                    fontWeight: 400,
                },

                // Template 3 state (Wealth style: image top, brand divider, bold yellow text bottom)
                t3: {
                    headline: "HOW MANY MILLIONAIRES AND BILLIONAIRES EXIST IN THE WORLD",
                    bgImage: "https://cdn.britannica.com/45/223045-050-A6453D5D/Telsa-CEO-Elon-Musk-2014.jpg",
                    fontFamily: 'Oswald',
                    fontSize: 86,
                    fontStyle: 'normal',
                    fontWeight: 700,
                    headlineColor: '#FFD800',
                    bgColor: '#0a0a0a',
                    imageSplit: 57,
                    imagePosX: 89,
                    imagePosY: 0,
                    imageScale: 100,
                    brandName: 'ealth',
                    brandLetter: 'w',
                    showBrandLetter: true,
                    brandColor: '#FFFFFF',
                    showBrand: true,
                    brandSize: 37,
                    lineHeight: 1.15,
                    letterSpacing: 0,
                    showBgColor: true,
                    showBottomFade: true,
                    bottomFadeColor: '#0a0a0a',
                    bottomFadeOpacity: 1.0,
                    bottomFadeHeight: 79,
                    bottomFadePosY: 0,
                },
                
                style: {
                    fontFamily: 'Archivo Black',
                    primaryColor: '#FFFFFF',
                    highlightColor: '#FF5500',
                    secondaryColor: '#3B82F6',
                    useBracketColor: true,
                    useBraceColor: true,
                    overlayColor: '#000000',
                    overlayOpacity: 0.5,
                    fontSize: 85,
                    lineHeight: 0.9,
                    letterSpacing: -0.02,
                    logoUrl: '',
                    logoSize: 150,
                    logoOpacity: 1.0,
                    showSwipeBadge: true,
                    showNewsBadge: true,
                    showSource: true,
                    badgeText: "NEWS",
                    sourceText: "SOURCE: GITHUB",
                    imagePosX: 50, imagePosY: 50, imageScale: 100,
                    bgOpacity: 1.0,
                    bgNoise: 0.0,
                    overlayImgUrl: 'https://raw.githubusercontent.com/nicholasxdavis/ptm/main/holder/aliens.jpg',
                    overlayImgSize: 450,
                    overlayImgPosX: 74, overlayImgPosY: 65,
                    overlayBorderWidth: 12,
                    overlayBorderColor: '#FF5500',
                    overlayNoise: 0.0,
                    watermarkUrl: 'https://raw.githubusercontent.com/nicholasxdavis/ptm/main/holder/example-watermark.png',
                    watermarkSize: 323,
                    watermarkPosX: 0,
                    watermarkPosY: 0,
                    watermarkOpacity: 0.8,
                    showWatermark: true,
                },
                sources: { bg: 'GITHUB', overlay: 'GITHUB', watermark: 'GITHUB' }
            },

            // Highlight State
            highlight: {
                iconType: 'icon', // 'icon' | 'custom' | 'fa'
                iconName: 'Mic',
                customIconUrl: '',
                faClass: '',
                bgColor: '#000000',
                ringColor: '#FF5500',
                iconColor: '#FFFFFF',
                ringWidth: 15,
                iconSize: 400
            },

            presets: []
        };

        const CONSTANTS = {
            POST_WIDTH: 1080,
            POST_HEIGHT: 1350,
            HIGHLIGHT_SIZE: 1080,
            FONTS: ['Google Sans', 'Arial', 'Archivo Black', 'Anton', 'Bebas Neue', 'Inter', 'Montserrat', 'Oswald', 'Poppins', 'Roboto Condensed', 'Teko'],
            COLORS: ['#FF5500', '#EF4444', '#3B82F6', '#10B981', '#A855F7', '#EAB308', '#000000', '#FFFFFF', '#06B6D4', '#EC4899', '#84CC16', '#6366F1', '#F97316', '#14B8A6']
        };

        // --- TEMPLATES SYSTEM ---
        const SYSTEM_TEMPLATES = [
            {
                id: 'template1',
                name: 'News (Classic)',
                previewImage: 'src/ui/templates/template1.png',
                templateId: 'template1',
                style: {
                    fontFamily: 'Archivo Black',
                    primaryColor: '#FFFFFF',
                    highlightColor: '#FF5500',
                    secondaryColor: '#3B82F6',
                    useBracketColor: true,
                    useBraceColor: true,
                    overlayColor: '#000000',
                    overlayOpacity: 0.5,
                    fontSize: 85,
                    lineHeight: 0.9,
                    letterSpacing: -0.02,
                    imagePosX: 50, imagePosY: 50, imageScale: 100,
                    bgOpacity: 1.0,
                    bgNoise: 0.0,
                    overlayImgSize: 450,
                    overlayImgPosX: 74, overlayImgPosY: 65,
                    overlayBorderWidth: 12,
                    overlayBorderColor: '#FF5500',
                    overlayNoise: 0.0,
                    watermarkSize: 323,
                    watermarkPosX: 0,
                    watermarkPosY: 0,
                    watermarkOpacity: 0.8,
                    showWatermark: true,
                    showSwipeBadge: true,
                    showNewsBadge: true,
                    showSource: true,
                    badgeText: "NEWS",
                    sourceText: "SOURCE: GITHUB"
                }
            },
            {
                id: 'template2',
                name: 'Clean (No Jumper)',
                previewImage: 'src/ui/templates/template2.png',
                templateId: 'template2'
            },
            {
                id: 'template3',
                name: 'Wealth (Split)',
                previewImage: 'src/ui/templates/template3.png',
                templateId: 'template3'
            }
        ];

        // Icon mapping for highlight generator
        const HIGHLIGHT_ICON_MAP = {
            'Mic': 'mic',
            'Music': 'music',
            'Video': 'video',
            'Zap': 'zap',
            'Star': 'star',
            'Heart': 'heart',
            'Trophy': 'trophy',
            'Flame': 'flame',
            'Play': 'play',
            'Camera': 'camera',
            'Headphones': 'headphones',
            'Radio': 'radio',
            'Tv': 'tv',
            'Smartphone': 'smartphone',
            'Laptop': 'laptop',
            'Gamepad': 'gamepad-2',
            'Dumbbell': 'dumbbell',
            'Plane': 'plane',
            'ShoppingBag': 'shopping-bag',
            'Shirt': 'shirt',
            'DollarSign': 'dollar-sign',
            'TrendingUp': 'trending-up',
            'Users': 'users',
            'MessageCircle': 'message-circle',
            'Calendar': 'calendar',
            'MapPin': 'map-pin',
            'Instagram': 'instagram',
            'Twitter': 'twitter',
            'Facebook': 'facebook',
            'Youtube': 'youtube',
            'Globe': 'globe',
            'Check': 'check'
        };

        // --- CORS PROXY UTILITY ---
        // For display, we use direct URLs (no CORS needed for img tags)
        // CORS is only needed when reading pixel data for canvas operations
        function getCorsProxyUrl(url) {
            // Return URL as-is for display purposes
            // img tags can load from any origin without CORS restrictions
            return url;
        }

        // --- PERFORMANCE OPTIMIZATION ---
        let renderTimeout = null;
        let resizeTimeout = null;

        function debounceRender(fn, delay = 50) {
            return function(...args) {
                clearTimeout(renderTimeout);
                renderTimeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function debounceResize(fn, delay = 150) {
            return function(...args) {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadPresets();
            lucide.createIcons();
            renderApp();
            window.addEventListener('resize', debounceResize(handleResize));
        });

        function loadPresets() {
            const saved = localStorage.getItem(PRESETS_KEY);
            if (saved) {
                try { 
                    state.presets = JSON.parse(saved); 
                } catch (e) { 
                    console.error('Failed to load presets:', e);
                    state.presets = [];
                }
            }
        }

        // --- ICON INITIALIZATION HELPER ---
        function initializeIcons(container = null) {
            if (typeof lucide === 'undefined' || !lucide.createIcons) {
                console.warn('Lucide library not available');
                return;
            }
            
            try {
                // Initialize icons in the container if provided
                if (container) {
                    lucide.createIcons(container);
                }
                // Also do global initialization
                lucide.createIcons();
            } catch (e) {
                console.warn('Error initializing icons:', e);
            }
        }

        // --- CORE RENDER LOOP ---
        function renderApp() {
            renderTabs();
            renderSidebarContent();
            renderCanvas();
            handleResize();
            // Initialize icons after DOM is updated - target sidebar specifically
            const sidebarContent = document.getElementById('sidebar-content');
            setTimeout(() => {
                initializeIcons(sidebarContent);
                // Re-initialize icons again to ensure all are loaded
                setTimeout(() => {
                    initializeIcons(sidebarContent);
                }, 50);
                // One more retry after a longer delay
                setTimeout(() => {
                    initializeIcons(sidebarContent);
                }, 150);
            }, 10);
            // Hide blank/empty icons after creation - wait longer to ensure icons are initialized
            setTimeout(() => {
                // Re-initialize icons one more time before checking
                initializeIcons(sidebarContent);
                
                // Now check for empty icons
                document.querySelectorAll('.icon-gallery-btn').forEach(btn => {
                    const iconEl = btn.querySelector('[data-lucide]');
                    if (iconEl) {
                        const svg = iconEl.querySelector('svg');
                        // Only hide if truly empty after waiting
                        if (!svg) {
                            // Wait a bit more before hiding
                            setTimeout(() => {
                                const retrySvg = iconEl.querySelector('svg');
                                if (!retrySvg) {
                                    btn.style.display = 'none';
                                }
                            }, 100);
                        } else if (svg.children.length === 0) {
                            // Check if SVG has any paths or meaningful content
                            const hasContent = svg.querySelector('path, circle, rect, line, polyline, polygon') !== null;
                            if (!hasContent) {
                                btn.style.display = 'none';
                            }
                        }
                    }
                });
            }, 500);
        }

        function setMode(mode) {
            if (state.mode === mode) return;
            state.mode = mode;
            state.activeTab = 'editor';
            
            // Update buttons
            const postBtn = document.getElementById('mode-post-btn');
            const highlightBtn = document.getElementById('mode-highlight-btn');
            
            if (postBtn && highlightBtn) {
                postBtn.className = mode === 'post' 
                    ? 'px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 bg-white text-black shadow-sm hover:shadow-md' 
                    : 'px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 text-gray-400 hover:text-gray-300';
                highlightBtn.className = mode === 'highlight' 
                    ? 'px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 bg-white text-black shadow-sm hover:shadow-md' 
                    : 'px-6 py-1.5 text-xs font-bold uppercase rounded-md transition-all-200 text-gray-400 hover:text-gray-300';
            }
            
            renderApp();
        }

        function setActiveTab(tab) {
            if (state.activeTab === tab) return;
            state.activeTab = tab;
            renderApp();
        }

        // --- SIDEBAR RENDERING ---
        function renderTabs() {
            const container = document.getElementById('tabs-container');
            if (!container) return;
            
            const tabs = state.mode === 'post' ? ['editor', 'design', 'templates'] : ['editor', 'templates'];
            
            container.innerHTML = tabs.map(tab => `
                <button
                    onclick="setActiveTab('${tab}')"
                    aria-label="${tab} tab"
                    aria-selected="${state.activeTab === tab}"
                >
                    ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
            `).join('');
        }

        function renderSidebarContent() {
            const container = document.getElementById('sidebar-content');
            if (!container) return;
            
            if (state.mode === 'post') {
                if (state.activeTab === 'editor') {
                    if (state.post.template === 'template2') renderTemplate2Editor(container);
                    else if (state.post.template === 'template3') renderTemplate3Editor(container);
                    else renderPostEditor(container);
                }
                else if (state.activeTab === 'templates') renderPostTemplates(container);
                else if (state.activeTab === 'design') {
                    if (state.post.template === 'template2') renderTemplate2Editor(container);
                    else if (state.post.template === 'template3') renderTemplate3Editor(container);
                    else renderPostDesign(container);
                }
            } else {
                if (state.activeTab === 'editor') renderHighlightEditor(container);
                else if (state.activeTab === 'templates') renderLibrary(container);
            }
            
            // Initialize Lucide icons after rendering content - target the container specifically
            setTimeout(() => {
                initializeIcons(container);
                // Also initialize icons in canvas if needed
                const canvasRoot = document.getElementById('canvas-root');
                if (canvasRoot && typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons(canvasRoot);
                }
                // Global initialization to catch all icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 10);
            
            // Retry after a longer delay to catch any late-rendering icons
            setTimeout(() => {
                initializeIcons(container);
                const canvasRoot = document.getElementById('canvas-root');
                if (canvasRoot && typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons(canvasRoot);
                }
                // Global initialization again
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 100);
            
            // One more retry for stubborn icons
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons(container);
                    lucide.createIcons();
                }
            }, 300);
        }

        // --- POST GENERATOR UI ---
        function renderPostEditor(container) {
            const s = state.post.style;
            const safeBgImage = state.post.bgImage.startsWith('data:') ? '' : escapeHtml(state.post.bgImage);
            
            container.innerHTML = `
                <!-- Background -->
                <div class="space-y-3 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                        <i data-lucide="image" class="w-3 h-3"></i> Background Image
                    </label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white" 
                            placeholder="Image URL..." 
                            oninput="updatePostBgUrl(this.value)" 
                            value="${safeBgImage}"
                            aria-label="Background image URL"
                        >
                        <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload background image">
                            <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event, 'postBg')">
                        </label>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Zoom</label>
                                <input 
                                    type="range" 
                                    min="100" 
                                    max="250" 
                                    value="${s.imageScale}" 
                                    oninput="updatePostStyleWithDisplay('imageScale', parseFloat(this.value), 'bg-zoom-display', 'percent-value')" 
                                    class="w-full"
                                    aria-label="Image zoom"
                                >
                                <div id="bg-zoom-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.imageScale}%</div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Opacity</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="1" 
                                    step="0.05" 
                                    value="${s.bgOpacity}" 
                                    oninput="updatePostStyleWithDisplay('bgOpacity', parseFloat(this.value), 'bg-opacity-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Background opacity"
                                >
                                <div id="bg-opacity-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(s.bgOpacity * 100)}%</div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-1.5">
                                <i data-lucide="sparkles" class="w-2.5 h-2.5"></i> Noise
                            </label>
                            <input 
                                type="range" 
                                min="0" 
                                max="1" 
                                step="0.05" 
                                value="${s.bgNoise}" 
                                oninput="updatePostStyleWithDisplay('bgNoise', parseFloat(this.value), 'bg-noise-display', 'percent')" 
                                class="w-full"
                                aria-label="Background noise"
                            >
                            <div id="bg-noise-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(s.bgNoise * 100)}%</div>
                        </div>
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos X</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value="${s.imagePosX}" 
                                    oninput="updatePostStyleWithDisplay('imagePosX', parseFloat(this.value), 'bg-posx-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Image position X"
                                >
                                <div id="bg-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.imagePosX}%</div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos Y</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value="${s.imagePosY}" 
                                    oninput="updatePostStyleWithDisplay('imagePosY', parseFloat(this.value), 'bg-posy-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Image position Y"
                                >
                                <div id="bg-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.imagePosY}%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overlay -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="circle" class="w-3 h-3"></i> Circle Overlay
                        </label>
                        ${s.overlayImgUrl ? `
                            <button 
                                onclick="updatePostStyle('overlayImgUrl', '')" 
                                class="text-red-500 text-[10px] font-medium hover:text-red-600 transition-colors"
                                aria-label="Remove overlay"
                            >
                                Remove
                            </button>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="input-overlay-url"
                            class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white" 
                            placeholder="Overlay URL..." 
                            oninput="updatePostOverlayUrl(this.value)"
                            value="${escapeHtml(s.overlayImgUrl)}"
                            aria-label="Overlay image URL"
                        >
                        <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload overlay image">
                            <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event, 'postOverlay')">
                        </label>
                    </div>
                    ${s.overlayImgUrl ? `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Size</label>
                                <input 
                                    type="range" 
                                    min="100" 
                                    max="800" 
                                    value="${s.overlayImgSize}" 
                                    oninput="updatePostStyleWithDisplay('overlayImgSize', parseFloat(this.value), 'overlay-size-display', 'px')" 
                                    class="w-full"
                                    aria-label="Overlay size"
                                >
                                <div id="overlay-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.overlayImgSize}px</div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Border</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="50" 
                                    value="${s.overlayBorderWidth}" 
                                    oninput="updatePostStyleWithDisplay('overlayBorderWidth', parseFloat(this.value), 'overlay-border-display', 'px')" 
                                    class="w-full"
                                    aria-label="Overlay border width"
                                >
                                <div id="overlay-border-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.overlayBorderWidth}px</div>
                            </div>
                        </div>
                        ${renderColorPicker('Border Color', s.overlayBorderColor, "updatePostStyle('overlayBorderColor', '$VAL')")}
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-1.5">
                                <i data-lucide="sparkles" class="w-2.5 h-2.5"></i> Noise
                            </label>
                            <input 
                                type="range" 
                                min="0" 
                                max="1" 
                                step="0.01" 
                                value="${s.overlayNoise}" 
                                oninput="updatePostStyleWithDisplay('overlayNoise', parseFloat(this.value), 'overlay-noise-display', 'percent')" 
                                class="w-full"
                                aria-label="Overlay noise"
                            >
                            <div id="overlay-noise-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(s.overlayNoise * 100)}%</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">X-Pos</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value="${s.overlayImgPosX}" 
                                    oninput="updatePostStyleWithDisplay('overlayImgPosX', parseFloat(this.value), 'overlay-posx-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Overlay position X"
                                >
                                <div id="overlay-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.overlayImgPosX}%</div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Y-Pos</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value="${s.overlayImgPosY}" 
                                    oninput="updatePostStyleWithDisplay('overlayImgPosY', parseFloat(this.value), 'overlay-posy-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Overlay position Y"
                                >
                                <div id="overlay-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.overlayImgPosY}%</div>
                            </div>
                        </div>
                    </div>` : ''}
                </div>

                <!-- Text -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                        <i data-lucide="type" class="w-3 h-3"></i> Content
                    </label>
                    <textarea 
                        id="input-headline"
                        oninput="state.post.headline = this.value; debouncedRenderCanvas()" 
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm font-mono focus:outline-none focus:border-black focus:bg-white transition-all-200 resize-none" 
                        rows="3"
                        placeholder="Enter headline... Use [brackets] and {braces} for colored text"
                        aria-label="Headline text"
                    >${escapeHtml(state.post.headline)}</textarea>
                    <input 
                        type="text" 
                        id="input-caption"
                        oninput="state.post.caption = this.value; debouncedRenderCanvas()" 
                        value="${escapeHtml(state.post.caption)}" 
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                        placeholder="Caption text..."
                        aria-label="Caption text"
                    >
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="input-source"
                            oninput="updatePostStyle('sourceText', this.value)" 
                            value="${escapeHtml(s.sourceText)}" 
                            class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                            placeholder="Source text..."
                            aria-label="Source text"
                        >
                        <button 
                            onclick="updatePostStyle('showSource', ${!s.showSource})" 
                            class="p-2.5 rounded-lg border border-gray-200 transition-all-200 ${s.showSource ? 'bg-black text-white border-black' : 'bg-white text-gray-400 hover:bg-gray-50'}"
                            aria-label="${s.showSource ? 'Hide' : 'Show'} source"
                        >
                            <i data-lucide="${s.showSource ? 'eye' : 'eye-off'}" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <!-- Badges -->
                <section class="space-y-4 pt-6 border-t border-gray-100 animate-fade-in">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="layers" class="w-3.5 h-3.5 text-gray-400"></i>
                        <h3 class="text-xs font-bold uppercase tracking-wider text-gray-900">Badges</h3>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold text-gray-500 uppercase">News Badge</span>
                            <input 
                                type="checkbox" 
                                id="input-showNewsBadge"
                                ${s.showNewsBadge ? 'checked' : ''} 
                                onchange="updatePostStyle('showNewsBadge', this.checked)" 
                                class="accent-black h-4 w-4 cursor-pointer"
                                aria-label="Toggle news badge"
                            >
                        </div>
                        ${s.showNewsBadge ? `
                            <input 
                                type="text" 
                                id="input-badgeText"
                                value="${escapeHtml(s.badgeText)}" 
                                oninput="updatePostStyle('badgeText', this.value)" 
                                class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs font-bold uppercase text-center focus:outline-none focus:border-black transition-all-200"
                                aria-label="Badge text"
                            >
                        ` : ''}
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex items-center justify-between hover:border-gray-300 transition-all-200">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Swipe Left Indicator</span>
                        <input 
                            type="checkbox" 
                            id="input-showSwipeBadge"
                            ${s.showSwipeBadge ? 'checked' : ''} 
                            onchange="updatePostStyle('showSwipeBadge', this.checked)" 
                            class="accent-black h-4 w-4 cursor-pointer"
                            aria-label="Toggle swipe badge"
                        >
                    </div>
                </section>

                <!-- Watermark -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="image" class="w-3 h-3"></i> Watermark
                        </label>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] text-gray-400">Show</span>
                            <input 
                                type="checkbox" 
                                id="input-showWatermark"
                                ${s.showWatermark ? 'checked' : ''} 
                                onchange="updatePostStyle('showWatermark', this.checked)" 
                                class="accent-black h-3.5 w-3.5 cursor-pointer"
                                aria-label="Toggle watermark"
                            >
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="input-watermarkUrl"
                            class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white" 
                            placeholder="Watermark URL..." 
                            oninput="updatePostStyle('watermarkUrl', this.value)"
                            value="${escapeHtml(s.watermarkUrl)}"
                            aria-label="Watermark image URL"
                        >
                        <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload watermark">
                            <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event, 'postWatermark')">
                        </label>
                    </div>
                    ${s.watermarkUrl ? `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Size</label>
                                <input 
                                    type="range" 
                                    min="50" 
                                    max="500" 
                                    value="${s.watermarkSize}" 
                                    oninput="updatePostStyleWithDisplay('watermarkSize', parseFloat(this.value), 'watermark-size-display', 'px')" 
                                    class="w-full"
                                    aria-label="Watermark size"
                                >
                                <div id="watermark-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.watermarkSize}px</div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Opacity</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="1" 
                                    step="0.01" 
                                    value="${s.watermarkOpacity}" 
                                    oninput="updatePostStyleWithDisplay('watermarkOpacity', parseFloat(this.value), 'watermark-opacity-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Watermark opacity"
                                >
                                <div id="watermark-opacity-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(s.watermarkOpacity * 100)}%</div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Position</label>
                            <div class="grid grid-cols-3 gap-1.5 mb-3">
                                <button onclick="setWatermarkPosition(10, 10)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 10 && s.watermarkPosY === 10 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Left">TL</button>
                                <button onclick="setWatermarkPosition(50, 10)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 50 && s.watermarkPosY === 10 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Center">TC</button>
                                <button onclick="setWatermarkPosition(90, 10)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 90 && s.watermarkPosY === 10 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Right">TR</button>
                                <button onclick="setWatermarkPosition(10, 50)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 10 && s.watermarkPosY === 50 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center Left">CL</button>
                                <button onclick="setWatermarkPosition(50, 50)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 50 && s.watermarkPosY === 50 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center">C</button>
                                <button onclick="setWatermarkPosition(90, 50)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 90 && s.watermarkPosY === 50 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center Right">CR</button>
                                <button onclick="setWatermarkPosition(10, 90)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 10 && s.watermarkPosY === 90 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Left">BL</button>
                                <button onclick="setWatermarkPosition(50, 90)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 50 && s.watermarkPosY === 90 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Center">BC</button>
                                <button onclick="setWatermarkPosition(90, 90)" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${s.watermarkPosX === 90 && s.watermarkPosY === 90 ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Right">BR</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Manual Position</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">X-Pos</label>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="100" 
                                        value="${s.watermarkPosX}" 
                                        oninput="updatePostStyleWithDisplay('watermarkPosX', parseFloat(this.value), 'watermark-posx-display', 'percent')" 
                                        class="w-full"
                                        aria-label="Watermark position X"
                                    >
                                    <div id="watermark-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.watermarkPosX}%</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Y-Pos</label>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="100" 
                                        value="${s.watermarkPosY}" 
                                        oninput="updatePostStyleWithDisplay('watermarkPosY', parseFloat(this.value), 'watermark-posy-display', 'percent')" 
                                        class="w-full"
                                        aria-label="Watermark position Y"
                                    >
                                    <div id="watermark-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.watermarkPosY}%</div>
                                </div>
                            </div>
                        </div>
                    </div>` : ''}
                </div>
            `;
        }

        function renderPostTemplates(container) {
            container.innerHTML = `
                <div class="space-y-4 animate-fade-in">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="layout-template" class="w-4 h-4 text-gray-400"></i>
                        <h3 class="text-xs font-bold uppercase tracking-wider" style="color: #dddddd;">System Templates</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        ${SYSTEM_TEMPLATES.map(t => `
                            <button 
                                onclick="loadSystemTemplate('${t.id}')" 
                                class="group relative flex flex-col items-start justify-start gap-2 p-3 rounded-lg border border-[#3e3e3e] hover:border-[#535353] hover:shadow-md transition-all-200 w-full h-full"
                                style="background-color: #131314 !important; text-align: left;"
                            >
                                <div class="w-full aspect-video rounded-md mb-1 overflow-hidden relative flex items-center justify-center" style="border: 1px solid #3e3e3e; background-color: #282828;">
                                    ${t.previewImage ? `
                                        <img src="${t.previewImage}" alt="${t.name}" class="w-full h-full object-cover">
                                    ` : `
                                        <!-- Simple CSS Preview Fallback -->
                                        <div class="absolute inset-0 opacity-20" style="background-color: ${t.previewColor || '#000'}"></div>
                                        <div class="scale-50 transform origin-center flex flex-col items-center gap-1 opacity-80">
                                           <div class="w-12 h-1 bg-current opacity-40 rounded-full"></div> 
                                           <div class="w-8 h-1 bg-current opacity-20 rounded-full"></div> 
                                        </div>
                                    `}
                                </div>
                                
                                <div class="w-full text-left">
                                    <span class="text-xs font-bold block leading-tight group-hover:text-white" style="color: #dddddd;">${t.name}</span>
                                    <span class="text-[9px] uppercase tracking-wider mt-0.5 block" style="color: #dddddd;">Preset</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-100">
                         <div class="rounded-lg p-3 flex gap-3" style="background-color: #282828; border: 1px solid #3e3e3e;">
                            <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5" style="color: #dddddd;"></i>
                            <div class="text-[10px] leading-relaxed" style="color: #dddddd;">
                                <strong class="block mb-0.5">How Templates Work</strong>
                                Selecting a template will update your editor settings (fonts, colors, layout). Your text content will stay safe!
                            </div>
                         </div>
                    </div>

                    <!-- Merged Library Content -->
                    <div class="mt-8 pt-6 border-t border-[#3e3e3e] space-y-6">
                       <div class="bg-[#282828] p-4 rounded-lg space-y-3" style="border: 1px solid #3e3e3e;">
                          <label class="text-[10px] font-bold text-gray-400 uppercase">Save Current State</label>
                          <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="preset-name-input" 
                                placeholder="Template Name..." 
                                class="flex-1 bg-[#1e1e1e] text-[#dddddd] rounded-lg px-3 py-2 text-xs focus:border-[#d53478] focus:outline-none transition-all-200 placeholder-gray-500"
                                style="border: 1px solid #3e3e3e;"
                                aria-label="Preset name"
                                onkeypress="if(event.key === 'Enter') savePreset()"
                            >
                            <button 
                                onclick="savePreset()" 
                                class="bg-[#d53478] hover:bg-[#b334a0] text-white p-2 rounded-lg transition-colors btn-primary"
                                aria-label="Save preset"
                            >
                                <i data-lucide="save" class="w-4 h-4"></i>
                            </button>
                          </div>
                       </div>

                       <div class="grid grid-cols-2 gap-2">
                            <button 
                                onclick="exportPresets()" 
                                class="flex items-center justify-center gap-2 p-3 bg-[#3e3e3e] hover:bg-[#4e4e4e] text-[#dddddd] text-xs font-bold uppercase rounded-lg transition-colors btn-primary"
                                aria-label="Export all presets"
                            >
                                <i data-lucide="folder-down" class="w-3.5 h-3.5"></i> Export All
                            </button>
                            <label class="flex items-center justify-center gap-2 p-3 bg-[#3e3e3e] hover:bg-[#4e4e4e] text-[#dddddd] text-xs font-bold uppercase rounded-lg transition-colors cursor-pointer btn-primary" aria-label="Import presets">
                                <i data-lucide="folder-up" class="w-3.5 h-3.5"></i> Import
                                <input type="file" hidden accept=".json" onchange="handleFileUpload(event, 'import')">
                            </label>
                       </div>

                       <div class="space-y-2">
                          <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Saved Templates</label>
                          ${state.presets.length === 0 ? `
                            <div class="text-center py-12 text-gray-500 text-xs rounded-lg bg-[#282828]" style="border: 1px solid #3e3e3e;">
                                No templates saved.
                            </div>
                          ` : `
                            <div class="space-y-2">
                                ${state.presets.map(p => `
                                    <div class="flex items-center justify-between bg-[#282828] p-3 rounded-lg hover:border-[#535353] transition-all-200 group shadow-sm" style="border: 1px solid #3e3e3e;">
                                       <div class="flex items-center gap-3">
                                           <div class="w-2 h-8 rounded-full bg-gray-700" style="background-color: ${p.style?.highlightColor || '#FF5500'}"></div>
                                           <span class="text-xs font-bold text-[#dddddd]">${escapeHtml(p.name)}</span>
                                       </div>
                                       <div class="flex items-center gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onclick="loadPreset(${p.id})" 
                                                class="p-1.5 hover:bg-[#3e3e3e] rounded-lg text-gray-400 hover:text-white transition-all-200" 
                                                title="Load"
                                                aria-label="Load preset ${escapeHtml(p.name)}"
                                            >
                                                <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                                            </button>
                                            <button 
                                                onclick="deletePreset(${p.id})" 
                                                class="p-1.5 hover:bg-[#3e3e3e] rounded-lg text-gray-400 hover:text-red-500 transition-all-200" 
                                                title="Delete"
                                                aria-label="Delete preset ${escapeHtml(p.name)}"
                                            >
                                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                            </button>
                                       </div>
                                    </div>
                                `).join('')}
                            </div>
                          `}
                       </div>
                    </div>
                </div>
            `;
            
            // Re-init icons
            setTimeout(() => initializeIcons(container), 0);
        }

        function loadSystemTemplate(id) {
            // Show loader in preview area (outside canvas)
            const previewContainer = document.getElementById('preview-container');
            const scaleWrapper = document.getElementById('scale-wrapper');
            let loader = null;

            if (previewContainer) {
                loader = document.createElement('div');
                loader.id = 'template-loader';
                loader.className = 'absolute inset-0 flex items-center justify-center z-50';
                // Scale up the loader using a wrapper to avoid animation conflict
                loader.innerHTML = '<div style="transform: scale(1.4);"><div class="loader"></div></div>'; 
                previewContainer.appendChild(loader);
            }

            if (scaleWrapper) {
                scaleWrapper.style.opacity = '0';
                scaleWrapper.style.transition = 'opacity 0.2s ease';
            }

            setTimeout(() => {
                const template = SYSTEM_TEMPLATES.find(t => t.id === id);
                if (!template) {
                    // Cleanup if failed
                    if (loader) loader.remove();
                    if (scaleWrapper) scaleWrapper.style.opacity = '1';
                    return;
                }
                
                // Switch the active template
                state.post.template = template.templateId || template.id;
                
                // For template1, merge style settings
                if (template.style) {
                    state.post.style = { ...state.post.style, ...template.style };
                }
                
                state.activeTab = 'editor';
                renderApp();

                // Remove loader and show canvas
                if (loader) loader.remove();
                if (scaleWrapper) {
                    scaleWrapper.style.opacity = '1';
                }
            }, 2000); // Wait 2 seconds
        }

        function renderPostDesign(container) {
            const s = state.post.style;
            container.innerHTML = `
                <!-- Font Family -->
                <div class="space-y-3 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Font Family</label>
                    <div class="grid grid-cols-1 gap-2">
                        ${CONSTANTS.FONTS.map(font => `
                            <button 
                                onclick="updatePostStyle('fontFamily', '${font}')" 
                                class="flex items-center justify-between px-4 py-3 rounded-lg border transition-all-200 ${s.fontFamily === font ? 'bg-black border-black text-white shadow-md' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-white hover:border-gray-300 hover:shadow-sm'}"
                                aria-label="Select ${font} font"
                            >
                                <span style="font-family: ${font}" class="text-lg">Aa</span>
                                <span class="text-xs uppercase tracking-widest font-bold">${font}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Colors -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Text Colors</label>
                    <div class="space-y-3">
                        <div class="space-y-2">
                            ${renderColorPicker('Bracket [ ] Color', s.highlightColor, "updatePostStyle('highlightColor', '$VAL')")}
                            ${renderColorPicker('Brace { } Color', s.secondaryColor, "updatePostStyle('secondaryColor', '$VAL')")}
                        </div>
                        <div class="flex flex-col gap-1 text-[10px] text-gray-600">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    ${s.useBracketColor ? 'checked' : ''} 
                                    onchange="updatePostStyle('useBracketColor', this.checked)" 
                                    class="square-checkbox"
                                >
                                <span>Use color for words inside [brackets]</span>
                            </label>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    ${s.useBraceColor ? 'checked' : ''} 
                                    onchange="updatePostStyle('useBraceColor', this.checked)" 
                                    class="square-checkbox"
                                >
                                <span>Use color for words inside {braces}</span>
                            </label>
                            <p class="text-[9px] text-gray-400 mt-1">
                                Turn both off for plain black text like the examples.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Branding -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Branding</label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="input-logoUrl"
                            value="${escapeHtml(s.logoUrl)}" 
                            oninput="updatePostStyle('logoUrl', this.value)" 
                            class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white" 
                            placeholder="Logo URL..."
                            aria-label="Logo URL"
                        >
                        <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload logo">
                            <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event, 'postLogo')">
                        </label>
                    </div>
                    ${s.logoUrl ? `
                        <div class="flex gap-4 pt-3">
                            <div class="flex-1">
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Size</label>
                                <input 
                                    type="range" 
                                    min="50" 
                                    max="400" 
                                    value="${s.logoSize}" 
                                    oninput="updatePostStyleWithDisplay('logoSize', parseFloat(this.value), 'logo-size-display', 'px')" 
                                    class="w-full"
                                    aria-label="Logo size"
                                >
                                <div id="logo-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.logoSize}px</div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Opacity</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="1" 
                                    step="0.01" 
                                    value="${s.logoOpacity}" 
                                    oninput="updatePostStyleWithDisplay('logoOpacity', parseFloat(this.value), 'logo-opacity-display', 'percent')" 
                                    class="w-full"
                                    aria-label="Logo opacity"
                                >
                                <div id="logo-opacity-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(s.logoOpacity * 100)}%</div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Typography Settings -->
                <div class="space-y-3 pt-6 border-t border-gray-100 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Typography Settings</label>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Size</label>
                            <input 
                                type="range" 
                                min="40" 
                                max="200" 
                                value="${s.fontSize}" 
                                oninput="updatePostStyleWithDisplay('fontSize', parseFloat(this.value), 'font-size-display', 'px')" 
                                class="w-full"
                                aria-label="Font size"
                            >
                            <div id="font-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.fontSize}px</div>
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Line Height</label>
                            <input 
                                type="range" 
                                min="0.5" 
                                max="1.5" 
                                step="0.01" 
                                value="${s.lineHeight}" 
                                oninput="updatePostStyleWithDisplay('lineHeight', parseFloat(this.value), 'line-height-display', 'number')" 
                                class="w-full"
                                aria-label="Line height"
                            >
                            <div id="line-height-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${s.lineHeight}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- TEMPLATE 2 SIDEBAR EDITOR ---
        function renderTemplate2Editor(container) {
            const t2 = state.post.t2;
            const safeBgUrl = t2.bgImage && !t2.bgImage.startsWith('data:') ? escapeHtml(t2.bgImage) : '';
            const safeWmUrl = t2.watermarkUrl && !t2.watermarkUrl.startsWith('data:') ? escapeHtml(t2.watermarkUrl) : '';
            
            container.innerHTML = `
                <div class="space-y-6 animate-fade-in">

                    <!-- Headline -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="type" class="w-3 h-3"></i> Headline
                        </label>
                        <textarea
                            id="t2-headline"
                            oninput="state.post.t2.headline = this.value; debouncedRenderCanvas()"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm font-mono focus:outline-none focus:border-black focus:bg-white transition-all-200 resize-none"
                            rows="4"
                            placeholder="Enter headline text..."
                            aria-label="Template 2 headline"
                        >${escapeHtml(t2.headline)}</textarea>
                    </div>

                    <!-- Font -->
                    <div class="space-y-2 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Font Family</label>
                        <div class="grid grid-cols-1 gap-2">
                            ${['DM Sans', 'Plus Jakarta Sans', 'Inter', 'Poppins', 'Montserrat', 'Roboto Condensed'].map(font => `
                                <button
                                    onclick="state.post.t2.fontFamily = '${font}'; debouncedRenderCanvas(); renderSidebarContent()"
                                    class="flex items-center justify-between px-4 py-3 rounded-lg border transition-all-200 ${t2.fontFamily === font ? 'bg-black border-black text-white shadow-md' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-white hover:border-gray-300 hover:shadow-sm'}"
                                    aria-label="${font} font"
                                >
                                    <span style="font-family: ${font}" class="text-lg">Aa</span>
                                    <span class="text-xs uppercase tracking-widest font-bold">${font}</span>
                                </button>
                            `).join('')}
                        </div>
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Font Size</label>
                            <input
                                type="range" min="28" max="120" value="${t2.fontSize}"
                                oninput="state.post.t2.fontSize = parseFloat(this.value); document.getElementById('t2-fs-display').textContent = this.value + 'px'; debouncedRenderCanvas()"
                                class="w-full" aria-label="Font size"
                            >
                            <div id="t2-fs-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.fontSize}px</div>
                        </div>
                        <!-- Font Weight -->
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Font Weight</label>
                            <div class="grid grid-cols-5 gap-1">
                                ${[['300','Light'],['400','Regular'],['500','Medium'],['600','Semi'],['700','Bold']].map(([w, label]) => `
                                    <button
                                        onclick="state.post.t2.fontWeight = ${w}; debouncedRenderCanvas(); renderSidebarContent()"
                                        class="py-2 rounded-lg border text-[9px] font-bold transition-all-200 ${String(t2.fontWeight) === w ? 'bg-black border-black text-white' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-400'}"
                                        style="font-weight:${w}"
                                        aria-label="${label} weight"
                                    >${label}</button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Image -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="image" class="w-3 h-3"></i> Image
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="text" id="t2-bg-url"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                                placeholder="Image URL..."
                                oninput="state.post.t2.bgImage = this.value; debouncedRenderCanvas()"
                                value="${safeBgUrl}"
                                aria-label="Template 2 image URL"
                            >
                            <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload image">
                                <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                                <input type="file" hidden accept="image/*" onchange="(e => { const f=e.target.files[0]; if(!f) return; e.target.value=''; const r=new FileReader(); r.onload=ev=>{state.post.t2.bgImage=ev.target.result; debouncedRenderCanvas();}; r.readAsDataURL(f); })(event)">
                            </label>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Zoom</label>
                                    <input type="range" min="100" max="250" value="${t2.imageScale}"
                                        oninput="state.post.t2.imageScale = parseFloat(this.value); document.getElementById('t2-zoom-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Image zoom">
                                    <div id="t2-zoom-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.imageScale}%</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos X</label>
                                    <input type="range" min="0" max="100" value="${t2.imagePosX}"
                                        oninput="state.post.t2.imagePosX = parseFloat(this.value); document.getElementById('t2-posx-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Image X position">
                                    <div id="t2-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.imagePosX}%</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos Y</label>
                                <input type="range" min="0" max="100" value="${t2.imagePosY}"
                                    oninput="state.post.t2.imagePosY = parseFloat(this.value); document.getElementById('t2-posy-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                    class="w-full" aria-label="Image Y position">
                                <div id="t2-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.imagePosY}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Watermark -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <i data-lucide="image" class="w-3 h-3"></i> Watermark
                            </label>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-gray-400">Show</span>
                                <input
                                    type="checkbox" id="t2-show-watermark"
                                    ${t2.showWatermark ? 'checked' : ''}
                                    onchange="state.post.t2.showWatermark = this.checked; debouncedRenderCanvas()"
                                    class="accent-black h-3.5 w-3.5 cursor-pointer"
                                    aria-label="Toggle watermark"
                                >
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input
                                type="text" id="t2-watermark-url"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                                placeholder="Watermark URL..."
                                oninput="state.post.t2.watermarkUrl = this.value; debouncedRenderCanvas()"
                                value="${safeWmUrl}"
                                aria-label="Watermark URL"
                            >
                            <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload watermark">
                                <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                                <input type="file" hidden accept="image/*" onchange="(e => { const f=e.target.files[0]; if(!f) return; e.target.value=''; const r=new FileReader(); r.onload=ev=>{state.post.t2.watermarkUrl=ev.target.result; state.post.t2.showWatermark=true; debouncedRenderCanvas();}; r.readAsDataURL(f); })(event)">
                            </label>
                        </div>
                        ${t2.watermarkUrl ? `
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Size</label>
                                    <input type="range" min="40" max="400" value="${t2.watermarkSize}"
                                        oninput="state.post.t2.watermarkSize = parseFloat(this.value); document.getElementById('t2-wm-size-display').textContent = this.value + 'px'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Watermark size">
                                    <div id="t2-wm-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.watermarkSize}px</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Opacity</label>
                                    <input type="range" min="0" max="1" step="0.01" value="${t2.watermarkOpacity}"
                                        oninput="state.post.t2.watermarkOpacity = parseFloat(this.value); document.getElementById('t2-wm-opacity-display').textContent = Math.round(this.value*100) + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Watermark opacity">
                                    <div id="t2-wm-opacity-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(t2.watermarkOpacity * 100)}%</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Position</label>
                                <div class="grid grid-cols-3 gap-1.5 mb-3">
                                    <button onclick="state.post.t2.watermarkPosX=10;state.post.t2.watermarkPosY=10;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===10&&t2.watermarkPosY===10?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Left">TL</button>
                                    <button onclick="state.post.t2.watermarkPosX=50;state.post.t2.watermarkPosY=10;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===50&&t2.watermarkPosY===10?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Center">TC</button>
                                    <button onclick="state.post.t2.watermarkPosX=90;state.post.t2.watermarkPosY=10;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===90&&t2.watermarkPosY===10?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Top Right">TR</button>
                                    <button onclick="state.post.t2.watermarkPosX=10;state.post.t2.watermarkPosY=50;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===10&&t2.watermarkPosY===50?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center Left">CL</button>
                                    <button onclick="state.post.t2.watermarkPosX=50;state.post.t2.watermarkPosY=50;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===50&&t2.watermarkPosY===50?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center">C</button>
                                    <button onclick="state.post.t2.watermarkPosX=90;state.post.t2.watermarkPosY=50;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===90&&t2.watermarkPosY===50?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Center Right">CR</button>
                                    <button onclick="state.post.t2.watermarkPosX=10;state.post.t2.watermarkPosY=90;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===10&&t2.watermarkPosY===90?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Left">BL</button>
                                    <button onclick="state.post.t2.watermarkPosX=50;state.post.t2.watermarkPosY=90;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===50&&t2.watermarkPosY===90?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Center">BC</button>
                                    <button onclick="state.post.t2.watermarkPosX=90;state.post.t2.watermarkPosY=90;debouncedRenderCanvas();renderSidebarContent()" class="p-2 text-[9px] font-bold uppercase rounded border transition-all-200 ${t2.watermarkPosX===90&&t2.watermarkPosY===90?'bg-black text-white border-black':'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}" title="Bottom Right">BR</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Manual Position</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">X-Pos</label>
                                        <input type="range" min="0" max="100" value="${t2.watermarkPosX}"
                                            oninput="state.post.t2.watermarkPosX = parseFloat(this.value); document.getElementById('t2-wm-posx-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                            class="w-full" aria-label="Watermark X position">
                                        <div id="t2-wm-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.watermarkPosX}%</div>
                                    </div>
                                    <div>
                                        <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Y-Pos</label>
                                        <input type="range" min="0" max="100" value="${t2.watermarkPosY}"
                                            oninput="state.post.t2.watermarkPosY = parseFloat(this.value); document.getElementById('t2-wm-posy-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                            class="w-full" aria-label="Watermark Y position">
                                        <div id="t2-wm-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t2.watermarkPosY}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}
                </div>
            `;
            setTimeout(() => initializeIcons(container), 0);
        }

        // --- TEMPLATE 3 SIDEBAR EDITOR (Wealth Split Style) ---
        function renderTemplate3Editor(container) {
            const t3 = state.post.t3;
            const safeBgUrl = t3.bgImage && !t3.bgImage.startsWith('data:') ? escapeHtml(t3.bgImage) : '';

            container.innerHTML = `
                <div class="space-y-6 animate-fade-in">

                    <!-- Headline -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="type" class="w-3 h-3"></i> Headline
                        </label>
                        <textarea
                            id="t3-headline"
                            oninput="state.post.t3.headline = this.value; debouncedRenderCanvas()"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm font-mono focus:outline-none focus:border-black focus:bg-white transition-all-200 resize-none"
                            rows="4"
                            placeholder="Enter headline text..."
                            aria-label="Template 3 headline"
                        >${escapeHtml(t3.headline)}</textarea>
                    </div>

                    <!-- Text Color -->
                    <div class="space-y-2 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Headline Color</label>
                        <div class="flex flex-wrap gap-2">
                            ${['#FFD800','#FF5500','#FFFFFF','#FF0000','#00FF88','#00CFFF','#FF00FF','#000000'].map(c => `
                                <button
                                    onclick="state.post.t3.headlineColor='${c}'; debouncedRenderCanvas(); renderSidebarContent()"
                                    class="w-8 h-8 rounded-lg transition-all-200 ${t3.headlineColor === c ? 'scale-110 shadow-md' : 'hover:scale-105'}"
                                    style="background-color:${c} !important; border: 2px solid ${t3.headlineColor === c ? '#000' : (c === '#FFFFFF' ? '#ccc' : 'transparent')}; box-shadow: 0 0 0 ${t3.headlineColor === c ? '2px rgba(0,0,0,0.4)' : '0px transparent'};"
                                    title="${c}"
                                ></button>
                            `).join('')}
                            <label class="w-8 h-8 rounded-lg border-2 border-dashed border-gray-400 flex items-center justify-center cursor-pointer hover:border-white transition-all-200" title="Custom color" style="background-color:${['#FFD800','#FF5500','#FFFFFF','#FF0000','#00FF88','#00CFFF','#FF00FF','#000000'].includes(t3.headlineColor) ? 'transparent' : t3.headlineColor} !important;">
                                <i data-lucide="pipette" class="w-3 h-3" style="color:${['#FFD800','#FF5500','#FFFFFF','#FF0000','#00FF88','#00CFFF','#FF00FF','#000000'].includes(t3.headlineColor) ? '#9ca3af' : '#fff'}"></i>
                                <input type="color" hidden value="${t3.headlineColor}" oninput="state.post.t3.headlineColor=this.value; debouncedRenderCanvas(); renderSidebarContent()">
                            </label>
                        </div>
                    </div>

                    <!-- Font -->
                    <div class="space-y-2 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Font Family</label>
                        <div class="grid grid-cols-1 gap-2">
                            ${['Oswald','Anton','Bebas Neue','Archivo Black','Montserrat','Roboto Condensed','Teko','Inter'].map(font => `
                                <button
                                    onclick="state.post.t3.fontFamily = '${font}'; debouncedRenderCanvas(); renderSidebarContent()"
                                    class="flex items-center justify-between px-4 py-3 rounded-lg border transition-all-200 ${t3.fontFamily === font ? 'bg-black border-black text-white shadow-md' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-white hover:border-gray-300 hover:shadow-sm'}"
                                    aria-label="${font} font"
                                >
                                    <span style="font-family: ${font}" class="text-lg">Aa</span>
                                    <span class="text-xs uppercase tracking-widest font-bold">${font}</span>
                                </button>
                            `).join('')}
                        </div>
                        <!-- Font Style -->
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Style</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button
                                    onclick="state.post.t3.fontStyle='normal'; debouncedRenderCanvas(); renderSidebarContent()"
                                    class="py-2 rounded-lg border text-xs font-bold transition-all-200 ${t3.fontStyle === 'normal' ? 'bg-black border-black text-white' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-400'}"
                                >Normal</button>
                                <button
                                    onclick="state.post.t3.fontStyle='italic'; debouncedRenderCanvas(); renderSidebarContent()"
                                    class="py-2 rounded-lg border text-xs font-bold italic transition-all-200 ${t3.fontStyle === 'italic' ? 'bg-black border-black text-white' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-400'}"
                                >Italic</button>
                            </div>
                        </div>
                        <!-- Font Size -->
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Font Size</label>
                            <input
                                type="range" min="40" max="160" value="${t3.fontSize}"
                                oninput="state.post.t3.fontSize = parseFloat(this.value); document.getElementById('t3-fs-display').textContent = this.value + 'px'; debouncedRenderCanvas()"
                                class="w-full" aria-label="Font size"
                            >
                            <div id="t3-fs-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.fontSize}px</div>
                        </div>
                        <!-- Font Weight -->
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Font Weight</label>
                            <div class="grid grid-cols-5 gap-1">
                                ${[['300','Light'],['400','Regular'],['500','Medium'],['600','Semi'],['700','Bold']].map(([w, label]) => `
                                    <button
                                        onclick="state.post.t3.fontWeight = ${w}; debouncedRenderCanvas(); renderSidebarContent()"
                                        class="py-2 rounded-lg border text-[9px] font-bold transition-all-200 ${String(t3.fontWeight) === w ? 'bg-black border-black text-white' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-400'}"
                                        style="font-weight:${w}"
                                        aria-label="${label} weight"
                                    >${label}</button>
                                `).join('')}
                            </div>
                        </div>
                        <!-- Line Height -->
                        <div class="pt-2">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Line Height</label>
                            <input
                                type="range" min="0.7" max="1.5" step="0.01" value="${t3.lineHeight}"
                                oninput="state.post.t3.lineHeight = parseFloat(this.value); document.getElementById('t3-lh-display').textContent = parseFloat(this.value).toFixed(2); debouncedRenderCanvas()"
                                class="w-full" aria-label="Line height"
                            >
                            <div id="t3-lh-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.lineHeight}</div>
                        </div>
                    </div>

                    <!-- Image -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="image" class="w-3 h-3"></i> Background Image
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="text" id="t3-bg-url"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                                placeholder="Image URL..."
                                oninput="state.post.t3.bgImage = this.value; debouncedRenderCanvas()"
                                value="${safeBgUrl}"
                                aria-label="Template 3 image URL"
                            >
                            <label class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-lg cursor-pointer transition-all-200 active:scale-95" aria-label="Upload image">
                                <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                                <input type="file" hidden accept="image/*" onchange="(e => { const f=e.target.files[0]; if(!f) return; e.target.value=''; const r=new FileReader(); r.onload=ev=>{state.post.t3.bgImage=ev.target.result; debouncedRenderCanvas();}; r.readAsDataURL(f); })(event)">
                            </label>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Zoom</label>
                                    <input type="range" min="100" max="250" value="${t3.imageScale}"
                                        oninput="state.post.t3.imageScale = parseFloat(this.value); document.getElementById('t3-zoom-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Image zoom">
                                    <div id="t3-zoom-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.imageScale}%</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos X</label>
                                    <input type="range" min="0" max="100" value="${t3.imagePosX}"
                                        oninput="state.post.t3.imagePosX = parseFloat(this.value); document.getElementById('t3-posx-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Image X position">
                                    <div id="t3-posx-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.imagePosX}%</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos Y</label>
                                <input type="range" min="0" max="100" value="${t3.imagePosY}"
                                    oninput="state.post.t3.imagePosY = parseFloat(this.value); document.getElementById('t3-posy-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                    class="w-full" aria-label="Image Y position">
                                <div id="t3-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.imagePosY}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Split -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                            <i data-lucide="layout" class="w-3 h-3"></i> Image / Text Split
                        </label>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Image Height <span class="normal-case font-normal">(% of canvas)</span></label>
                            <input type="range" min="30" max="75" value="${t3.imageSplit}"
                                oninput="state.post.t3.imageSplit = parseFloat(this.value); document.getElementById('t3-split-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                class="w-full" aria-label="Image/text split">
                            <div id="t3-split-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.imageSplit}%</div>
                        </div>

                        <!-- Background Color with toggle -->
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-[9px] uppercase font-bold text-gray-400">Background Color</label>
                                <label class="flex items-center gap-1.5 cursor-pointer">
                                    <span class="text-[9px] text-gray-400">Enable</span>
                                    <input type="checkbox" ${t3.showBgColor !== false ? 'checked' : ''}
                                        onchange="state.post.t3.showBgColor = this.checked; debouncedRenderCanvas(); renderSidebarContent()"
                                        class="accent-black h-3.5 w-3.5 cursor-pointer" aria-label="Toggle background color">
                                </label>
                            </div>
                            ${t3.showBgColor !== false ? `
                            <div class="flex items-center gap-2 pt-1">
                                <input type="color" value="${t3.bgColor}"
                                    oninput="state.post.t3.bgColor = this.value; debouncedRenderCanvas()"
                                    class="w-10 h-8 rounded cursor-pointer border border-gray-200" aria-label="Background color">
                                <span class="text-xs text-gray-500 font-mono">${t3.bgColor}</span>
                            </div>
                            ` : `<p class="text-[9px] text-gray-400 pt-1">Disabled — image fills full canvas. Use Bottom Fade for darkening.</p>`}
                        </div>

                        <!-- Bottom Fade -->
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-[9px] uppercase font-bold text-gray-400 flex items-center gap-1.5">
                                    <i data-lucide="sunset" class="w-3 h-3"></i> Bottom Fade
                                </label>
                                <label class="flex items-center gap-1.5 cursor-pointer">
                                    <span class="text-[9px] text-gray-400">Enable</span>
                                    <input type="checkbox" ${t3.showBottomFade ? 'checked' : ''}
                                        onchange="state.post.t3.showBottomFade = this.checked; debouncedRenderCanvas(); renderSidebarContent()"
                                        class="accent-black h-3.5 w-3.5 cursor-pointer" aria-label="Toggle bottom fade">
                                </label>
                            </div>
                            ${t3.showBottomFade ? `
                            <div class="space-y-3">
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Fade Color</label>
                                    <div class="flex flex-wrap gap-1.5 mb-2">
                                        ${['#000000','#111111','#1a0a00','#0a0010','#001018','#0a1800','#1a0008'].map(c => `
                                            <button onclick="state.post.t3.bottomFadeColor='${c}'; debouncedRenderCanvas(); renderSidebarContent()"
                                                class="w-7 h-7 rounded border-2 transition-all-200 ${t3.bottomFadeColor === c ? 'border-black scale-110 shadow-md' : 'border-transparent hover:scale-105'}"
                                                style="background:${c};" title="${c}"></button>
                                        `).join('')}
                                        <label class="w-7 h-7 rounded border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:border-gray-500 transition-all-200" title="Custom color">
                                            <i data-lucide="pipette" class="w-3 h-3 text-gray-400"></i>
                                            <input type="color" hidden value="${t3.bottomFadeColor}"
                                                oninput="state.post.t3.bottomFadeColor=this.value; debouncedRenderCanvas(); renderSidebarContent()">
                                        </label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="color" value="${t3.bottomFadeColor}"
                                            oninput="state.post.t3.bottomFadeColor = this.value; debouncedRenderCanvas()"
                                            class="w-10 h-8 rounded cursor-pointer border border-gray-200" aria-label="Fade color">
                                        <span class="text-[9px] text-gray-500 font-mono">${t3.bottomFadeColor}</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Fade Height</label>
                                    <input type="range" min="15" max="100" value="${t3.bottomFadeHeight}"
                                        oninput="state.post.t3.bottomFadeHeight = parseFloat(this.value); document.getElementById('t3-fade-h-display').textContent = this.value + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Fade height">
                                    <div id="t3-fade-h-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.bottomFadeHeight}%</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Fade Strength</label>
                                    <input type="range" min="0.1" max="1" step="0.01" value="${t3.bottomFadeOpacity}"
                                        oninput="state.post.t3.bottomFadeOpacity = parseFloat(this.value); document.getElementById('t3-fade-op-display').textContent = Math.round(this.value*100) + '%'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Fade strength">
                                    <div id="t3-fade-op-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${Math.round(t3.bottomFadeOpacity * 100)}%</div>
                                </div>
                                <div>
                                    <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Pos Y <span class="normal-case font-normal">(shift up/down)</span></label>
                                    <input type="range" min="-200" max="200" value="${t3.bottomFadePosY || 0}"
                                        oninput="state.post.t3.bottomFadePosY = parseFloat(this.value); document.getElementById('t3-fade-posy-display').textContent = this.value + 'px'; debouncedRenderCanvas()"
                                        class="w-full" aria-label="Fade Y position">
                                    <div id="t3-fade-posy-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.bottomFadePosY || 0}px</div>
                                </div>
                            </div>
                            ` : `<p class="text-[9px] text-gray-400">Fades the bottom of your image into the text section for a seamless transition.</p>`}
                        </div>
                    </div>

                    <!-- Brand Divider -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <i data-lucide="minus-square" class="w-3 h-3"></i> Brand Divider
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <span class="text-[9px] text-gray-400">Show</span>
                                <input type="checkbox" ${t3.showBrand ? 'checked' : ''}
                                    onchange="state.post.t3.showBrand = this.checked; debouncedRenderCanvas()"
                                    class="accent-black h-3.5 w-3.5 cursor-pointer" aria-label="Toggle brand divider">
                            </label>
                        </div>
                        <!-- Circle Logo Letter -->
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-[9px] uppercase font-bold text-gray-400">Circle Logo Letter</label>
                                <label class="flex items-center gap-1.5 cursor-pointer">
                                    <span class="text-[9px] text-gray-400">Show</span>
                                    <input type="checkbox" ${t3.showBrandLetter !== false ? 'checked' : ''}
                                        onchange="state.post.t3.showBrandLetter = this.checked; debouncedRenderCanvas(); renderSidebarContent()"
                                        class="accent-black h-3.5 w-3.5 cursor-pointer" aria-label="Toggle circle letter">
                                </label>
                            </div>
                            ${t3.showBrandLetter !== false ? `
                            <div>
                                <label class="text-[9px] text-gray-400 block mb-1.5">Pick any letter for the ⓔ circle</label>
                                <div class="grid grid-cols-9 gap-1 mb-2">
                                    ${'abcdefghijklmnopqrstuvwxyz'.split('').map(l => `
                                        <button
                                            onclick="state.post.t3.brandLetter='${l}'; debouncedRenderCanvas(); renderSidebarContent()"
                                            class="h-7 rounded text-[10px] font-bold uppercase border transition-all-200 ${(t3.brandLetter||'w') === l ? 'bg-black border-black text-white' : 'bg-white border-gray-200 text-gray-600 hover:border-gray-400'}"
                                        >${l}</button>
                                    `).join('')}
                                </div>
                                <div class="flex gap-2 items-center">
                                    <label class="text-[9px] text-gray-400 shrink-0">Custom:</label>
                                    <input type="text" maxlength="1"
                                        value="${escapeHtml(t3.brandLetter || 'w')}"
                                        oninput="if(this.value.trim()) { state.post.t3.brandLetter=this.value.trim().charAt(0); debouncedRenderCanvas(); }"
                                        class="w-12 bg-white border border-gray-200 rounded-lg p-1.5 text-xs text-center font-mono focus:outline-none focus:border-black transition-all-200"
                                        placeholder="w" aria-label="Custom circle letter">
                                </div>
                            </div>
                            ` : `<p class="text-[9px] text-gray-400">Circle logo hidden — only brand name shows.</p>`}
                        </div>

                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Brand Name</label>
                            <input type="text" value="${escapeHtml(t3.brandName)}"
                                oninput="state.post.t3.brandName = this.value; debouncedRenderCanvas()"
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs transition-all-200 focus:bg-white"
                                placeholder="e.g. ealth, CNN, Forbes..."
                                aria-label="Brand name">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Brand Color</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" value="${t3.brandColor}"
                                        oninput="state.post.t3.brandColor = this.value; debouncedRenderCanvas()"
                                        class="w-10 h-8 rounded cursor-pointer border border-gray-200" aria-label="Brand color">
                                    <span class="text-[9px] text-gray-500 font-mono">${t3.brandColor}</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1.5">Brand Size</label>
                                <input type="range" min="12" max="40" value="${t3.brandSize}"
                                    oninput="state.post.t3.brandSize = parseFloat(this.value); document.getElementById('t3-brand-size-display').textContent = this.value + 'px'; debouncedRenderCanvas()"
                                    class="w-full" aria-label="Brand size">
                                <div id="t3-brand-size-display" class="text-[10px] text-gray-500 mt-1 text-center font-mono">${t3.brandSize}px</div>
                            </div>
                        </div>
                    </div>

                </div>
            `;
            setTimeout(() => initializeIcons(container), 0);
        }

        // --- HIGHLIGHT GENERATOR UI ---
        function renderHighlightEditor(container) {
            const h = state.highlight;
            const icons = Object.keys(HIGHLIGHT_ICON_MAP);
            
            container.innerHTML = `
                <!-- Icon Source -->
                <div class="space-y-3 animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2">
                        <i data-lucide="grid" class="w-3 h-3"></i> Icon Source
                    </label>
                    
                    <div class="bg-[#282828] p-4 rounded-lg space-y-4" style="border: 1px solid #3e3e3e;">
                        <div class="grid grid-cols-2 gap-2">
                            <button 
                                onclick="updateHighlightState('iconType', 'icon')" 
                                class="rounded-lg p-3 text-center transition-all-200 flex flex-col items-center gap-1 ${h.iconType === 'icon' ? 'bg-[#131314] text-white shadow-md' : 'bg-[#1e1e1e] text-gray-400 hover:bg-[#323232] hover:shadow-sm'}"
                                style="${h.iconType === 'icon' ? 'border: 1px solid #d53478;' : 'border: 1px solid #3e3e3e;'}"
                                aria-label="Use icon gallery"
                            >
                                <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                                <span class="text-xs font-bold">Gallery</span>
                                <span class="text-[9px] opacity-70">Lucide</span>
                            </button>
                            <label class="cursor-pointer rounded-lg p-3 text-center transition-all-200 flex flex-col items-center gap-1 ${h.iconType === 'custom' ? 'bg-[#131314] text-white shadow-md' : 'bg-[#1e1e1e] text-gray-400 hover:bg-[#323232] hover:shadow-sm'}" style="${h.iconType === 'custom' ? 'border: 1px solid #d53478;' : 'border: 1px solid #3e3e3e;'}" aria-label="Upload custom icon">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span class="text-xs font-bold">Upload</span>
                                <span class="text-[9px] opacity-70">Custom PNG</span>
                                <input type="file" hidden accept="image/*" onchange="handleFileUpload(event, 'highlightIcon')">
                            </label>
                        </div>

                        <!-- FontAwesome Input -->
                        <div class="pt-2 border-t border-[#3e3e3e]">
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">FontAwesome Class</label>
                            <input 
                                type="text" 
                                value="${escapeHtml(h.faClass)}" 
                                oninput="updateHighlightState('faClass', this.value); updateHighlightState('iconType', 'fa')" 
                                class="w-full bg-[#1e1e1e] border border-[#3e3e3e] rounded-lg p-2.5 text-xs font-mono transition-all-200 focus:bg-[#131314] focus:border-[#d53478] focus:outline-none text-[#dddddd] placeholder-gray-600" 
                                placeholder="e.g. fa-brands fa-spotify"
                                aria-label="FontAwesome class"
                            >
                        </div>

                        <!-- Gallery -->
                        ${h.iconType === 'icon' ? `
                                <div class="pt-2 border-t border-[#3e3e3e]">
                                <label class="text-[9px] uppercase font-bold text-gray-400 block mb-2">Select Icon</label>
                                <div class="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto p-1" style="max-width: 100%;">
                                    ${icons.map(icon => {
                                        const lucideName = HIGHLIGHT_ICON_MAP[icon];
                                        return `
                                            <button 
                                                onclick="updateHighlightState('iconName', '${icon}')" 
                                                class="icon-gallery-btn p-2 rounded-lg flex items-center justify-center transition-all-200 ${h.iconName === icon ? 'bg-[#d53478] text-white shadow-md scale-110' : 'bg-[#1e1e1e] text-gray-400 hover:bg-[#323232] hover:shadow-sm'}"
                                                style="min-width: 36px; min-height: 36px; max-width: 36px; max-height: 36px; border: 1px solid ${h.iconName === icon ? '#d53478' : '#3e3e3e'};"
                                                aria-label="Select ${icon} icon"
                                            >
                                                <i data-lucide="${lucideName}" class="w-4 h-4 icon-lucide"></i>
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Colors & Settings -->
                <div class="space-y-3 pt-6 border-t border-[#3e3e3e] animate-fade-in">
                    <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2">
                        <i data-lucide="palette" class="w-3 h-3"></i> Colors & Settings
                    </label>
                    
                    <div class="bg-[#282828] p-4 rounded-lg space-y-4" style="border: 1px solid #3e3e3e;">
                        <div class="space-y-3">
                            <label class="text-[9px] uppercase font-bold text-gray-400 block">Colors</label>
                            <div class="grid grid-cols-1 gap-2">
                                ${renderColorPicker('Background', h.bgColor, "updateHighlightState('bgColor', '$VAL')")}
                                ${renderColorPicker('Ring', h.ringColor, "updateHighlightState('ringColor', '$VAL')")}
                                ${renderColorPicker('Icon', h.iconColor, "updateHighlightState('iconColor', '$VAL')")}
                            </div>
                        </div>

                        <div class="pt-3 border-t border-[#3e3e3e] space-y-4">
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <label class="text-[9px] uppercase font-bold text-gray-400">Ring Thickness</label>
                                    <span id="highlight-ring-width-display" class="text-[10px] font-mono text-gray-500">${h.ringWidth}px</span>
                                </div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value="${h.ringWidth}" 
                                    oninput="updateHighlightStateWithDisplay('ringWidth', parseInt(this.value), 'highlight-ring-width-display', 'px')" 
                                    class="w-full"
                                    aria-label="Ring thickness"
                                >
                            </div>
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <label class="text-[9px] uppercase font-bold text-gray-400">Icon Size</label>
                                    <span id="highlight-icon-size-display" class="text-[10px] font-mono text-gray-500">${h.iconSize}px</span>
                                </div>
                                <input 
                                    type="range" 
                                    min="100" 
                                    max="800" 
                                    value="${h.iconSize}" 
                                    oninput="updateHighlightStateWithDisplay('iconSize', parseInt(this.value), 'highlight-icon-size-display', 'px')" 
                                    class="w-full"
                                    aria-label="Icon size"
                                >
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize icons multiple times with delays to ensure they render in the gallery
            setTimeout(() => {
                initializeIcons(container);
            }, 10);
            setTimeout(() => {
                initializeIcons(container);
            }, 50);
            setTimeout(() => {
                initializeIcons(container);
            }, 150);
        }

        function renderLibrary(container) {
            container.innerHTML = `
                <div class="space-y-6 animate-fade-in">
                   <div class="bg-[#282828] p-4 rounded-lg space-y-3" style="border: 1px solid #3e3e3e;">
                      <label class="text-[10px] font-bold text-gray-400 uppercase">Save Current State</label>
                      <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="preset-name-input" 
                            placeholder="Template Name..." 
                            class="flex-1 bg-[#1e1e1e] text-[#dddddd] rounded-lg px-3 py-2 text-xs focus:border-[#d53478] focus:outline-none transition-all-200 placeholder-gray-500"
                            style="border: 1px solid #3e3e3e;"
                            aria-label="Preset name"
                            onkeypress="if(event.key === 'Enter') savePreset()"
                        >
                        <button 
                            onclick="savePreset()" 
                            class="bg-[#d53478] hover:bg-[#b334a0] text-white p-2 rounded-lg transition-colors btn-primary"
                            aria-label="Save preset"
                        >
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                      </div>
                   </div>

                   <div class="grid grid-cols-2 gap-2">
                        <button 
                            onclick="exportPresets()" 
                            class="flex items-center justify-center gap-2 p-3 bg-[#3e3e3e] hover:bg-[#4e4e4e] text-[#dddddd] text-xs font-bold uppercase rounded-lg transition-colors btn-primary"
                            aria-label="Export all presets"
                        >
                            <i data-lucide="folder-down" class="w-3.5 h-3.5"></i> Export All
                        </button>
                        <label class="flex items-center justify-center gap-2 p-3 bg-[#3e3e3e] hover:bg-[#4e4e4e] text-[#dddddd] text-xs font-bold uppercase rounded-lg transition-colors cursor-pointer btn-primary" aria-label="Import presets">
                            <i data-lucide="folder-up" class="w-3.5 h-3.5"></i> Import
                            <input type="file" hidden accept=".json" onchange="handleFileUpload(event, 'import')">
                        </label>
                   </div>

                   <div class="space-y-2">
                      <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Saved Templates</label>
                      ${state.presets.length === 0 ? `
                        <div class="text-center py-12 text-gray-500 text-xs rounded-lg bg-[#282828]" style="border: 1px solid #3e3e3e;">
                            No templates saved.
                        </div>
                      ` : `
                        <div class="space-y-2">
                            ${state.presets.map(p => `
                                <div class="flex items-center justify-between bg-[#282828] p-3 rounded-lg hover:border-[#535353] transition-all-200 group shadow-sm" style="border: 1px solid #3e3e3e;">
                                   <div class="flex items-center gap-3">
                                       <div class="w-2 h-8 rounded-full bg-gray-700" style="background-color: ${p.style?.highlightColor || '#FF5500'}"></div>
                                       <span class="text-xs font-bold text-[#dddddd]">${escapeHtml(p.name)}</span>
                                   </div>
                                   <div class="flex items-center gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                        <button 
                                            onclick="loadPreset(${p.id})" 
                                            class="p-1.5 hover:bg-[#3e3e3e] rounded-lg text-gray-400 hover:text-white transition-all-200" 
                                            title="Load"
                                            aria-label="Load preset ${escapeHtml(p.name)}"
                                        >
                                            <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button 
                                            onclick="deletePreset(${p.id})" 
                                            class="p-1.5 hover:bg-[#3e3e3e] rounded-lg text-gray-400 hover:text-red-500 transition-all-200" 
                                            title="Delete"
                                            aria-label="Delete preset ${escapeHtml(p.name)}"
                                        >
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                   </div>
                                </div>
                            `).join('')}
                        </div>
                      `}
                   </div>
                </div>
            `;
        }

        // --- CANVAS RENDERERS ---
        const debouncedRenderCanvas = debounceRender(() => {
            renderCanvas();
            // Initialize icons in canvas after rendering
            setTimeout(() => {
                const canvasRoot = document.getElementById('canvas-root');
                if (canvasRoot && typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons(canvasRoot);
                }
            }, 10);
        }, 100);

        function renderCanvas() {
            const root = document.getElementById('canvas-root');
            if (!root) return;

            if (state.mode === 'post') {
                const s = state.post.style;
                // Parse headline logic
                const parts = state.post.headline.split(/(\[.*?\]|\{.*?\})/);
                const headlineHTML = parts.map(part => {
                    if (part.startsWith('[') && part.endsWith(']')) {
                        const text = escapeHtml(part.slice(1, -1));
                        if (s.useBracketColor) {
                            return `<span style="color: ${s.highlightColor}">${text}</span>`;
                        }
                        return `<span style="color: ${s.primaryColor}">${text}</span>`;
                    }
                    if (part.startsWith('{') && part.endsWith('}')) {
                        const text = escapeHtml(part.slice(1, -1));
                        if (s.useBraceColor) {
                            return `<span style="color: ${s.secondaryColor}">${text}</span>`;
                        }
                        return `<span style="color: ${s.primaryColor}">${text}</span>`;
                    }
                    return `<span style="color: ${s.primaryColor}">${escapeHtml(part)}</span>`;
                }).join('');

                root.style.width = `${CONSTANTS.POST_WIDTH}px`;
                root.style.height = `${CONSTANTS.POST_HEIGHT}px`;

                // ── TEMPLATE 2 CANVAS (Clean: white top bar + full image + watermark BL) ──
                if (state.post.template === 'template2') {
                    const t2 = state.post.t2;
                    const safeT2Img = escapeHtml(getCorsProxyUrl(t2.bgImage));
                    const safeT2Headline = escapeHtml(t2.headline);
                    const safeT2Watermark = t2.watermarkUrl ? escapeHtml(getCorsProxyUrl(t2.watermarkUrl)) : '';

                    // Build watermark transform anchoring (same logic as template1)
                    let t2WmTX = '-50%', t2WmTY = '-50%';
                    if (t2.watermarkPosY <= 15)  t2WmTY = '0%';
                    else if (t2.watermarkPosY >= 85) t2WmTY = '-100%';
                    if (t2.watermarkPosX <= 15)  t2WmTX = '0%';
                    else if (t2.watermarkPosX >= 85) t2WmTX = '-100%';

                    root.innerHTML = `
                        <div style="position:absolute;inset:0;display:flex;flex-direction:column;background:#fff;">
                            <!-- White top bar with headline -->
                            <div
                                data-ctx="headline"
                                title="Click to edit headline"
                                ondblclick="focusSidebarControl('t2-headline')"
                                style="background:#fff;padding:40px 44px 36px 44px;flex-shrink:0;cursor:pointer;"
                            >
                                <p style="margin:0;font-family:${t2.fontFamily},sans-serif;font-size:${t2.fontSize}px;font-weight:${t2.fontWeight};color:#000;line-height:1.22;letter-spacing:-0.01em;">${safeT2Headline}</p>
                            </div>
                            <!-- Full image fills remaining space -->
                            <div
                                data-ctx="background"
                                title="Click to edit image"
                                ondblclick="focusSidebarControl('t2-bg-url')"
                                style="position:relative;flex:1;overflow:hidden;cursor:pointer;"
                            >
                                <img
                                    src="${safeT2Img}"
                                    style="width:100%;height:100%;object-fit:cover;object-position:${t2.imagePosX}% ${t2.imagePosY}%;transform:scale(${t2.imageScale/100});"
                                    onerror="this.style.display='none'"
                                    alt="Background"
                                >
                                ${safeT2Watermark && t2.showWatermark ? `
                                    <div
                                        data-ctx="watermark"
                                        title="Click to edit watermark"
                                        ondblclick="focusSidebarControl('t2-watermark-url')"
                                        style="position:absolute;left:${t2.watermarkPosX}%;top:${t2.watermarkPosY}%;transform:translate(${t2WmTX},${t2WmTY});cursor:pointer;opacity:${t2.watermarkOpacity};"
                                    >
                                        <img
                                            src="${safeT2Watermark}"
                                            style="width:${t2.watermarkSize}px;height:auto;object-fit:contain;pointer-events:none;"
                                            onerror="this.style.display='none'"
                                            alt="Watermark"
                                        >
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    return; // Done — skip template1 rendering below
                }

                // ── TEMPLATE 3 CANVAS (Wealth Split: image top, brand divider, bold colored text bottom) ──
                if (state.post.template === 'template3') {
                    const t3 = state.post.t3;
                    const safeT3Img = escapeHtml(getCorsProxyUrl(t3.bgImage));
                    const safeT3Headline = escapeHtml(t3.headline);
                    const imgHeightPx = Math.round((t3.imageSplit / 100) * CONSTANTS.POST_HEIGHT);
                    const brandSizePx = t3.brandSize;
                    const circleSizePx = Math.round(brandSizePx * 1.4);
                    const showBg = t3.showBgColor !== false;
                    // Fading divider line: gradient from transparent → color → transparent
                    const dividerLine = `background:linear-gradient(to right, transparent 0%, ${t3.brandColor} 20%, ${t3.brandColor} 80%, transparent 100%);height:1.5px;flex:1;`;

                    root.innerHTML = `
                        <div style="position:absolute;inset:0;background:${showBg ? t3.bgColor : '#000'};overflow:hidden;">

                            <!-- LAYER 1: Image — full canvas when bg disabled, cropped when enabled -->
                            <div
                                data-ctx="background"
                                title="Click to edit image"
                                ondblclick="focusSidebarControl('t3-bg-url')"
                                style="position:absolute;top:0;left:0;right:0;${showBg ? `height:${imgHeightPx}px` : 'bottom:0'};overflow:hidden;cursor:pointer;"
                            >
                                <img
                                    src="${safeT3Img}"
                                    style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:${t3.imagePosX}% ${t3.imagePosY}%;transform:scale(${t3.imageScale/100});transform-origin:center center;"
                                    onerror="this.style.display='none'"
                                    alt="Background"
                                >
                                <!-- Bottom fade: bleeds image into the text area below -->
                                ${t3.showBottomFade ? `
                                <div style="position:absolute;bottom:calc(${showBg ? '-2px' : '0px'} + ${-(t3.bottomFadePosY || 0)}px);left:0;right:0;height:${t3.bottomFadeHeight}%;background:linear-gradient(to bottom, transparent 0%, ${t3.bottomFadeColor} 100%);opacity:${t3.bottomFadeOpacity};pointer-events:none;"></div>
                                ` : ''}
                            </div>

                            <!-- LAYER 2: Content column (spacer → brand divider → headline) -->
                            <div style="position:absolute;inset:0;display:flex;flex-direction:column;pointer-events:none;">

                                <!-- Spacer matching image height — fades bgColor in at the bottom -->
                                <div style="height:${imgHeightPx}px;flex-shrink:0;background:${showBg ? `linear-gradient(to bottom, transparent 70%, ${t3.bgColor} 100%)` : 'transparent'};pointer-events:none;"></div>

                                <!-- BRAND DIVIDER -->
                                ${t3.showBrand ? `
                                <div
                                    data-ctx="brand"
                                    title="Click to edit brand"
                                    ondblclick="focusSidebarControl('t3-bg-url')"
                                    style="display:flex;align-items:center;gap:0;padding:18px 52px;background:${showBg ? t3.bgColor : 'transparent'};flex-shrink:0;cursor:pointer;pointer-events:auto;"
                                >
                                    <div style="${dividerLine}"></div>
                                    <div style="display:flex;align-items:center;gap:6px;padding:0 18px;white-space:nowrap;">
                                        ${t3.showBrandLetter !== false ? `<span style="display:inline-flex;align-items:center;justify-content:center;width:${circleSizePx}px;height:${circleSizePx}px;border:1.5px solid ${t3.brandColor};border-radius:50%;font-size:${brandSizePx * 0.7}px;font-family:Georgia,serif;font-style:italic;color:${t3.brandColor};line-height:1;">${escapeHtml((t3.brandLetter || 'w').charAt(0))}</span>` : ''}
                                        <span style="font-family:Georgia,serif;font-style:italic;font-size:${brandSizePx}px;color:${t3.brandColor};letter-spacing:0.04em;line-height:1;">${escapeHtml(t3.brandName)}</span>
                                    </div>
                                    <div style="${dividerLine}"></div>
                                </div>
                                ` : `<div style="height:24px;flex-shrink:0;background:${showBg ? t3.bgColor : 'transparent'};"></div>`}

                                <!-- HEADLINE -->
                                <div
                                    data-ctx="headline"
                                    title="Click to edit headline"
                                    ondblclick="focusSidebarControl('t3-headline')"
                                    style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px 52px 40px 52px;background:${showBg ? t3.bgColor : 'transparent'};cursor:pointer;pointer-events:auto;"
                                >
                                    <h1 style="position:relative;z-index:2;margin:0;font-family:'${t3.fontFamily}',sans-serif;font-size:${t3.fontSize}px;font-weight:${t3.fontWeight};font-style:${t3.fontStyle};color:${t3.headlineColor};text-align:center;text-transform:uppercase;line-height:${t3.lineHeight};letter-spacing:${t3.letterSpacing}em;word-break:break-word;">${safeT3Headline}</h1>
                                </div>

                            </div>


                        </div>
                    `;
                    return; // Done — skip template1 rendering below
                }

                // ── TEMPLATE 1 setup ──
                const safeBgImage = escapeHtml(getCorsProxyUrl(state.post.bgImage));
                const safeOverlayUrl = s.overlayImgUrl ? escapeHtml(getCorsProxyUrl(s.overlayImgUrl)) : '';
                const safeLogoUrl = s.logoUrl ? escapeHtml(getCorsProxyUrl(s.logoUrl)) : '';
                const safeWatermarkUrl = s.watermarkUrl ? escapeHtml(getCorsProxyUrl(s.watermarkUrl)) : '';
                const safeBadgeText = escapeHtml(s.badgeText);
                const safeSourceText = escapeHtml(s.sourceText);
                const safeCaption = escapeHtml(state.post.caption);
                
                // Calculate watermark transform based on position
                let watermarkTransformX = '-50%';
                let watermarkTransformY = '-50%';
                if (s.watermarkUrl) {
                    // Top row - anchor to top
                    if (s.watermarkPosY <= 15) watermarkTransformY = '0%';
                    // Bottom row - anchor to bottom
                    else if (s.watermarkPosY >= 85) watermarkTransformY = '-100%';
                    
                    // Left column - anchor to left
                    if (s.watermarkPosX <= 15) watermarkTransformX = '0%';
                    // Right column - anchor to right
                    else if (s.watermarkPosX >= 85) watermarkTransformX = '-100%';
                }

                // Classic template layout (single, flexible template)
                root.innerHTML = `
                    <div class="absolute inset-0 z-0 bg-black overflow-hidden" data-ctx="background" title="Click to edit background" ondblclick="focusSidebarControl('input-bg-image')" style="cursor:pointer;">
                        <img 
                            src="${safeBgImage}" 
                            style="width: 100%; height: 100%; object-fit: cover; object-position: ${s.imagePosX}% ${s.imagePosY}%; transform: scale(${s.imageScale/100}); opacity: ${s.bgOpacity};" 
                            onerror="this.style.display='none'"
                            alt="Background"
                        >
                        <div class="absolute inset-0 pointer-events-none mix-blend-overlay" style="background-image: url('${NOISE_SVG}'); opacity: ${s.bgNoise}"></div>
                    </div>
                    <div class="absolute inset-0 z-10" style="background: linear-gradient(to bottom, transparent 0%, transparent 40%, ${s.overlayColor} 85%, ${s.overlayColor} 100%)"></div>
                    <div class="absolute inset-0 z-10 pointer-events-none" style="background-color: ${s.overlayColor}; opacity: ${s.overlayOpacity}"></div>

                    ${safeOverlayUrl ? `
                        <div class="absolute z-[15] rounded-full shadow-2xl overflow-hidden box-content ${s.showOverlay !== false ? '' : 'ctx-ghost'}" data-ctx="circle-overlay" title="Click to edit circle" ondblclick="focusSidebarControl('input-overlay-url')" style="width: ${s.overlayImgSize}px; height: ${s.overlayImgSize}px; left: ${s.overlayImgPosX}%; top: ${s.overlayImgPosY}%; transform: translate(-50%, -50%); border: ${s.overlayBorderWidth}px solid ${s.overlayBorderWidth > 0 ? s.overlayBorderColor : 'transparent'}; cursor:pointer;">
                            <img 
                                src="${safeOverlayUrl}" 
                                style="width: 100%; height: 100%; object-fit: cover;" 
                                onerror="this.style.display='none'"
                                alt="Overlay"
                            >
                            <div class="absolute inset-0 pointer-events-none mix-blend-overlay" style="background-image: url('${NOISE_SVG}'); opacity: ${s.overlayNoise}"></div>
                        </div>
                    ` : ''}

                    ${safeLogoUrl ? `
                        <div class="absolute top-10 left-10 z-30 ${s.showLogo !== false ? '' : 'ctx-ghost'}" data-ctx="logo" title="Click to edit logo" ondblclick="focusSidebarControl('input-logoUrl')" style="opacity: ${s.logoOpacity}; width: ${s.logoSize}px; cursor:pointer;">
                            <img 
                                src="${safeLogoUrl}" 
                                style="width: 100%; height: auto; filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));" 
                                onerror="this.style.display='none'"
                                alt="Logo"
                            >
                        </div>
                    ` : ''}
                    
                    <div class="absolute top-12 right-10 z-30 flex flex-col items-end gap-2">
                        <div class="text-white text-xl font-bold uppercase tracking-widest drop-shadow-md flex items-center gap-2 opacity-90 ${s.showSwipeBadge ? '' : 'ctx-ghost'}" data-ctx="swipe-left" title="Click to edit" ondblclick="focusSidebarControl('input-showSwipeBadge')" style="font-family: 'Inter', sans-serif; cursor:pointer;">
                            Swipe Left <i data-lucide="chevron-right" class="w-6 h-6 stroke-[3px]"></i>
                        </div>
                    </div>

                    <div class="absolute inset-0 z-20 flex flex-col justify-end p-16" style="pointer-events:none;">
                        <div class="flex flex-col items-start gap-6 mb-8">
                            <div class="bg-white text-black px-4 py-1 text-xl font-bold uppercase tracking-wider mb-2 shadow-lg ${s.showNewsBadge ? '' : 'ctx-ghost'}" data-ctx="badge" title="Click to edit badge" ondblclick="focusSidebarControl('input-badgeText')" style="font-family: 'Archivo Black', sans-serif; cursor:pointer; pointer-events:auto;">
                                ${safeBadgeText}
                            </div>
                            <h1 class="uppercase break-words w-full" data-ctx="headline" title="Click to edit text" ondblclick="focusSidebarControl('input-headline')" style="font-family: ${s.fontFamily}; font-size: ${s.fontSize}px; line-height: ${s.lineHeight}; letter-spacing: ${s.letterSpacing}em; text-shadow: 0 4px 20px rgba(0,0,0,0.6); cursor:pointer; pointer-events:auto;">
                                ${headlineHTML}
                            </h1>
                            ${safeCaption ? `
                                <p class="text-neutral-200 text-2xl font-medium leading-relaxed opacity-90 max-w-[95%] drop-shadow-md" data-ctx="caption" title="Click to edit caption" ondblclick="focusSidebarControl('input-caption')" style="cursor:pointer; pointer-events:auto;">
                                    ${safeCaption}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    <div class="absolute bottom-8 right-12 z-30 text-right ${s.showSource ? '' : 'ctx-ghost'}" data-ctx="source" title="Click to edit source" ondblclick="focusSidebarControl('input-source')" style="cursor:pointer;">
                        <p class="text-lg text-neutral-400 uppercase tracking-widest font-bold opacity-60 drop-shadow-md font-sans">
                            ${safeSourceText}
                        </p>
                    </div>
                    ${s.watermarkUrl ? `
                        <div class="absolute z-40 ${s.showWatermark ? '' : 'ctx-ghost'}" data-ctx="watermark" title="Click to edit watermark" ondblclick="focusSidebarControl('input-watermarkUrl')" style="left: ${s.watermarkPosX}%; top: ${s.watermarkPosY}%; transform: translate(${watermarkTransformX}, ${watermarkTransformY}); opacity: ${s.watermarkOpacity}; cursor:pointer;">
                            <img 
                                src="${safeWatermarkUrl}" 
                                style="width: ${s.watermarkSize}px; height: auto; object-fit: contain; pointer-events:none;" 
                                onerror="this.style.display='none'"
                                alt="Watermark"
                            >
                        </div>
                    ` : ''}
                `;
            } else {
                // Highlight
                const h = state.highlight;
                root.style.width = `${CONSTANTS.HIGHLIGHT_SIZE}px`;
                root.style.height = `${CONSTANTS.HIGHLIGHT_SIZE}px`;
                root.style.backgroundColor = h.bgColor;
                
                let iconHTML = '';
                if (h.iconType === 'custom' && h.customIconUrl) {
                    iconHTML = `<img src="${escapeHtml(getCorsProxyUrl(h.customIconUrl))}" style="width: ${h.iconSize}px; height: ${h.iconSize}px; object-fit: contain;" onerror="this.style.display='none'" alt="Custom icon">`;
                } else if (h.iconType === 'fa' && h.faClass) {
                    iconHTML = `<i class="${escapeHtml(h.faClass)}" style="font-size: ${h.iconSize}px; color: ${h.iconColor}"></i>`;
                } else {
                    // Lucide icon - use iconMap to get correct Lucide name
                    const iconDisplayName = h.iconName || 'Mic';
                    const lucideIconName = HIGHLIGHT_ICON_MAP[iconDisplayName] || 'mic';
                    iconHTML = `<i data-lucide="${lucideIconName}" style="width: ${h.iconSize}px; height: ${h.iconSize}px; color: ${h.iconColor}"></i>`;
                }

                root.innerHTML = `
                    <div class="relative w-full h-full flex items-center justify-center overflow-hidden">
                        <div class="absolute rounded-full border-solid box-border" data-ctx="highlight-ring" title="Click to edit ring" style="width: 90%; height: 90%; border-color: ${h.ringColor}; border-width: ${h.ringWidth}px; cursor:pointer;"></div>
                        <div class="flex items-center justify-center z-10" data-ctx="highlight-icon" title="Click to edit icon" style="cursor:pointer;">${iconHTML}</div>
                    </div>
                `;
            }
        }

        // --- UTILITY FUNCTIONS ---
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- EVENTS & ACTIONS ---
        function updatePostStyle(key, value) {
            state.post.style[key] = value;
            debouncedRenderCanvas();
        }

        function updateT2State(key, value) {
            state.post.t2[key] = value;
            debouncedRenderCanvas();
        }

        function updateT3State(key, value) {
            state.post.t3[key] = value;
            debouncedRenderCanvas();
        }

        // Helper function to update style and display value in real-time
        function updatePostStyleWithDisplay(key, value, displayId, format = 'number') {
            state.post.style[key] = value;
            const displayEl = document.getElementById(displayId);
            if (displayEl) {
                if (format === 'percent') {
                    displayEl.textContent = Math.round(value * 100) + '%';
                } else if (format === 'percent-value') {
                    // For values that are already percentages (like zoom 100-250)
                    displayEl.textContent = Math.round(value) + '%';
                } else if (format === 'px') {
                    displayEl.textContent = Math.round(value) + 'px';
                } else if (format === 'number') {
                    displayEl.textContent = value;
                } else {
                    displayEl.textContent = value;
                }
            }
            debouncedRenderCanvas();
        }

        // Helper function to update highlight state and display value in real-time
        function updateHighlightStateWithDisplay(key, value, displayId, format = 'number') {
            state.highlight[key] = value;
            const displayEl = document.getElementById(displayId);
            if (displayEl) {
                if (format === 'percent') {
                    displayEl.textContent = Math.round(value * 100) + '%';
                } else if (format === 'px') {
                    displayEl.textContent = Math.round(value) + 'px';
                } else if (format === 'number') {
                    displayEl.textContent = value;
                } else {
                    displayEl.textContent = value;
                }
            }
            debouncedRenderCanvas();
            // Initialize icons in canvas after rendering
            setTimeout(() => {
                const canvasRoot = document.getElementById('canvas-root');
                if (canvasRoot && typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons(canvasRoot);
                }
            }, 50);
        }

        function setWatermarkPosition(x, y) {
            state.post.style.watermarkPosX = x;
            state.post.style.watermarkPosY = y;
            renderSidebarContent(); // Re-render to update button states
            debouncedRenderCanvas();
        }

        function updatePostBgUrl(val) {
            if (val && val.trim()) { 
                state.post.bgImage = val.trim(); 
                state.post.sources.bg = getHostname(val); 
                debouncedRenderCanvas();
            }
        }

        function updatePostOverlayUrl(val) {
            if (val && val.trim()) { 
                state.post.style.overlayImgUrl = val.trim(); 
                state.post.sources.overlay = getHostname(val); 
                renderSidebarContent();
                debouncedRenderCanvas();
            }
        }

        function updateHighlightState(key, value) {
            state.highlight[key] = value;
            renderSidebarContent();
            debouncedRenderCanvas();
            // Ensure icons are initialized after state update
            setTimeout(() => {
                const container = document.getElementById('sidebar-content');
                if (container) {
                    initializeIcons(container);
                }
                // Also initialize globally to catch any missed icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function handleResize() {
            const container = document.getElementById('preview-container');
            const wrapper = document.getElementById('scale-wrapper');
            if (container && wrapper) {
                const targetW = state.mode === 'post' ? CONSTANTS.POST_WIDTH : CONSTANTS.HIGHLIGHT_SIZE;
                const targetH = state.mode === 'post' ? CONSTANTS.POST_HEIGHT : CONSTANTS.HIGHLIGHT_SIZE;
                let scale = Math.min((container.offsetWidth - 40) / targetW, (container.offsetHeight - 40) / targetH);
                
                // On mobile, reduce Highlight Creator scale by 20%
                if (window.innerWidth <= 768 && state.mode === 'highlight') {
                    scale *= 0.8;
                }

                wrapper.style.transform = `scale(${scale})`;
                wrapper.style.width = `${targetW}px`;
                wrapper.style.height = `${targetH}px`;
            }
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset input
            event.target.value = '';
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                const res = ev.target.result;
                try {
                    if (type === 'postBg') {
                        state.post.bgImage = res;
                        state.post.sources.bg = 'FILE';
                        debouncedRenderCanvas();
                    } else if (type === 'postOverlay') {
                        state.post.style.overlayImgUrl = res;
                        state.post.sources.overlay = 'FILE';
                        renderSidebarContent();
                        debouncedRenderCanvas();
                    } else if (type === 'postLogo') {
                        state.post.style.logoUrl = res;
                        renderSidebarContent();
                        debouncedRenderCanvas();
                    } else if (type === 'postWatermark') {
                        state.post.style.watermarkUrl = res;
                        state.post.style.showWatermark = true;
                        state.post.sources.watermark = 'FILE';
                        renderSidebarContent();
                        debouncedRenderCanvas();
                    } else if (type === 'highlightIcon') {
                        state.highlight.customIconUrl = res;
                        state.highlight.iconType = 'custom';
                        renderSidebarContent();
                        debouncedRenderCanvas();
                    } else if (type === 'import') {
                        const data = JSON.parse(res);
                        let presetsToImport = [];
                        
                        // Handle both old format (array) and new format (object with metadata)
                        if (Array.isArray(data)) {
                            // Old format - direct array
                            presetsToImport = data;
                        } else if (data && data.presets && Array.isArray(data.presets)) {
                            // New format - object with metadata
                            presetsToImport = data.presets;
                        } else {
                            showNotification('Invalid preset file format. Expected array or object with presets.', 'error');
                            return;
                        }
                        
                        // Validate presets structure
                        const validPresets = presetsToImport.filter(p => {
                            return p && 
                                   typeof p.id !== 'undefined' && 
                                   typeof p.name === 'string' && 
                                   p.name.trim().length > 0 &&
                                   p.style && 
                                   typeof p.style === 'object';
                        });
                        
                        if (validPresets.length === 0) {
                            showNotification('No valid presets found in file', 'error');
                            return;
                        }
                        
                        // Merge with existing presets (avoid duplicates by ID)
                        const existingIds = new Set(state.presets.map(p => p.id));
                        const newPresets = validPresets.filter(p => !existingIds.has(p.id));
                        const duplicates = validPresets.length - newPresets.length;
                        
                        state.presets = [...state.presets, ...newPresets];
                        localStorage.setItem(PRESETS_KEY, JSON.stringify(state.presets));
                        renderSidebarContent();
                        
                        let message = `Imported ${newPresets.length} preset(s)!`;
                        if (duplicates > 0) {
                            message += ` (${duplicates} duplicate(s) skipped)`;
                        }
                        showNotification(message, 'success');
                    }
                } catch (e) {
                    console.error('File upload error:', e);
                    showNotification('Failed to process file', 'error');
                }
            };
            
            reader.onerror = () => {
                showNotification('Failed to read file', 'error');
            };
            
            if (type === 'import') {
                reader.readAsText(file);
            } else {
                reader.readAsDataURL(file);
            }
        }

        function savePreset() {
            const input = document.getElementById('preset-name-input');
            if (!input) return;
            
            const name = input.value.trim();
            if (!name) {
                showNotification('Please enter a template name', 'error');
                input.focus();
                return;
            }
            
            // Check for duplicate names
            const duplicate = state.presets.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (duplicate) {
                if (!confirm(`A preset named "${name}" already exists. Overwrite it?`)) {
                    return;
                }
                // Remove duplicate
                state.presets = state.presets.filter(p => p.id !== duplicate.id);
            }
            
            // Deep clone the style object to ensure all properties are saved
            const styleCopy = JSON.parse(JSON.stringify(state.post.style));
            
            const preset = {
                id: Date.now(),
                name,
                style: styleCopy,
                mode: state.mode,
                createdAt: new Date().toISOString()
            };
            
            state.presets.push(preset);
            localStorage.setItem(PRESETS_KEY, JSON.stringify(state.presets));
            input.value = '';
            renderSidebarContent();
            showNotification(`Preset "${name}" saved!`, 'success');
        }

        function loadPreset(id) {
            const p = state.presets.find(x => x.id === id);
            if (!p) {
                showNotification('Preset not found', 'error');
                return;
            }
            
            if (!p.style) {
                showNotification('Invalid preset: missing style data', 'error');
                return;
            }
            
            try {
                // Deep merge to preserve any new properties that might not be in old presets
                const mergedStyle = {
                    ...state.post.style, // Start with current defaults
                    ...p.style // Override with preset values
                };
                
                state.post.style = mergedStyle;
                
                // If preset has a mode, optionally switch to it
                if (p.mode && p.mode !== state.mode) {
                    if (confirm(`This preset was created for ${p.mode} mode. Switch to ${p.mode} mode?`)) {
                        setMode(p.mode);
                    }
                }
                
                renderCanvas();
                renderSidebarContent();
                lucide.createIcons();
                showNotification(`Preset "${p.name}" loaded!`, 'success');
            } catch (e) {
                console.error('Load preset error:', e);
                showNotification('Failed to load preset: ' + e.message, 'error');
            }
        }

        function deletePreset(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            state.presets = state.presets.filter(x => x.id !== id);
            localStorage.setItem(PRESETS_KEY, JSON.stringify(state.presets));
            renderSidebarContent();
            showNotification('Template deleted', 'success');
        }

        function exportPresets() {
            try {
                if (!state.presets || state.presets.length === 0) {
                    showNotification('No presets to export. Save a preset first!', 'error');
                    return;
                }
                
                // Create export data with metadata
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    presetCount: state.presets.length,
                    presets: state.presets
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `presets-${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification(`Exported ${state.presets.length} preset(s)!`, 'success');
            } catch (e) {
                console.error('Export error:', e);
                showNotification('Failed to export presets: ' + e.message, 'error');
            }
        }

        function getHostname(url) {
            try { 
                return new URL(url).hostname; 
            } catch (e) { 
                return 'WEB'; 
            }
        }

        function renderColorPicker(label, currentColor, onChangeStr) {
            const id = Math.random().toString(36).substr(2, 9);
            const toggleId = `cp-${id}`;
            
            // Create a global handler function name
            const handlerName = `handleColorPick_${id}`;
            
            // Parse the onChange string to extract function name and parameter
            // Format is like: "updatePostStyle('highlightColor', '$VAL')"
            const match = onChangeStr.match(/^(\w+)\(['"]([^'"]+)['"],\s*['"]\$VAL['"]\)$/);
            
            // Register the handler globally
            window[handlerName] = function(color) {
                try {
                    if (match) {
                        // Direct function call approach
                        const funcName = match[1];
                        const paramName = match[2];
                        
                        if (funcName === 'updatePostStyle') {
                            updatePostStyle(paramName, color);
                        } else if (funcName === 'updateHighlightState') {
                            updateHighlightState(paramName, color);
                        } else {
                            // Fallback to eval (safe in this context since we control the input)
                            const code = onChangeStr.replace(/\$VAL/g, JSON.stringify(color));
                            const fn = new Function('return ' + code);
                            fn();
                        }
                    } else {
                        // Fallback: try to execute the onChange string directly
                        const code = onChangeStr.replace(/\$VAL/g, JSON.stringify(color));
                        const fn = new Function('return ' + code);
                        fn();
                    }
                    
                    // Close the picker
                    const picker = document.getElementById(toggleId);
                    if (picker) picker.classList.add('hidden');
                    
                    // Re-render sidebar to update the color display
                    renderSidebarContent();
                } catch (e) {
                    console.error('Color picker error:', e);
                    console.error('OnChange string:', onChangeStr);
                    console.error('Color value:', color);
                }
            };
            
            return `
                <div class="relative">
                    <label class="text-[9px] font-bold text-gray-400 uppercase block mb-1.5">${label}</label>
                    <button 
                        onclick="document.getElementById('${toggleId}').classList.toggle('hidden')" 
                        class="flex items-center gap-2 bg-[#1e1e1e] rounded-lg p-1.5 w-full transition-all-200 group"
                        style="border: 1px solid #3e3e3e;"
                        onmouseover="this.style.borderColor='#535353'"
                        onmouseout="this.style.borderColor='#3e3e3e'"
                        aria-label="Open color picker for ${label}"
                    >
                        <div class="w-6 h-6 rounded-md shadow-sm" style="background-color: ${currentColor}; border: 1px solid #3e3e3e;"></div>
                        <span class="text-xs font-mono text-gray-400 group-hover:text-[#dddddd] flex-1 text-left whitespace-nowrap">${currentColor}</span>
                        <i data-lucide="sliders" class="w-3 h-3 text-gray-500"></i>
                    </button>
                    <div id="${toggleId}" class="hidden absolute top-full left-0 mt-2 z-50 bg-[#282828] rounded-xl shadow-xl p-3 w-64 color-picker-popover" style="border: 1px solid #3e3e3e;">
                        <div class="grid grid-cols-7 gap-2 mb-3">
                            ${CONSTANTS.COLORS.map(c => {
                                const escapedColor = c.replace(/'/g, "\\'");
                                return `
                                <button 
                                    onclick="document.getElementById('${toggleId}').classList.add('hidden'); window['${handlerName}']('${escapedColor}')" 
                                    class="w-6 h-6 rounded-full hover:scale-110 transition-all-200 color-picker-btn" 
                                    style="background-color: ${c} !important; border: 1px solid ${c === '#FFFFFF' ? '#3e3e3e' : 'rgba(0,0,0,0.1)'}; --btn-bg-color: ${c};"
                                    aria-label="Select color ${c}"
                                ></button>
                            `;
                            }).join('')}
                        </div>
                        <div class="relative w-full h-8 overflow-hidden rounded-lg" style="border: 1px solid #3e3e3e;">
                            <input 
                                type="color" 
                                value="${currentColor}" 
                                oninput="window['${handlerName}'](this.value)" 
                                class="absolute inset-0 w-[150%] h-[150%] -top-1/4 -left-1/4 cursor-pointer p-0 border-0"
                                aria-label="Color picker"
                            >
                        </div>
                    </div>
                </div>
            `;
        }

        function showNotification(message, type = 'success') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 bg-${type === 'success' ? 'green' : 'red'}-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        async function exportCanvas() {
            if (state.isExporting) {
                showNotification('Export already in progress...', 'error');
                return;
            }
            
            const root = document.getElementById('canvas-root');
            const wrapper = document.getElementById('scale-wrapper');
            const exportBtn = document.getElementById('export-btn');
            const exportText = document.getElementById('export-text');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            if (!root || !wrapper) {
                showNotification('Canvas not found', 'error');
                return;
            }
            
            // Check if html2canvas is available
            if (!window.html2canvas) {
                showNotification('Export library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            state.isExporting = true;
            
            // Show loading state
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.classList.add('export-loading');
            }
            if (exportText) exportText.textContent = 'Exporting...';
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
            
            const originalTransform = wrapper.style.transform;
            const originalPosition = wrapper.style.position;
            const originalLeft = wrapper.style.left;
            const originalTop = wrapper.style.top;
            
            try {
                // Temporary reset for clean capture
                wrapper.style.transform = 'none';
                wrapper.style.position = 'fixed';
                wrapper.style.left = '200vw';
                wrapper.style.top = '0';
                
                // Wait for any images to load
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Wait for all images in the canvas to load
                const images = root.querySelectorAll('img');
                const imagePromises = Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = resolve; // Continue even if image fails
                        setTimeout(resolve, 3000); // Timeout after 3 seconds
                    });
                });
                await Promise.all(imagePromises);
                
                const canvas = await window.html2canvas(root, {
                    scale: 1,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: null,
                    logging: false,
                    imageTimeout: 5000,
                    removeContainer: false
                });
                
                if (!canvas) {
                    throw new Error('Failed to generate canvas');
                }
                
                const dataUrl = canvas.toDataURL('image/png');
                if (!dataUrl || dataUrl === 'data:,') {
                    throw new Error('Failed to generate image data');
                }
                
                const link = document.createElement('a');
                link.download = `instagram-post-${Date.now()}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Image exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                let errorMsg = 'Export failed. ';
                if (error.message) {
                    errorMsg += error.message;
                } else if (error.toString().includes('CORS')) {
                    errorMsg += 'CORS error - some images may not export. Try using uploaded images instead of URLs.';
                } else {
                    errorMsg += 'Please try again.';
                }
                showNotification(errorMsg, 'error');
            } finally {
                // Restore
                wrapper.style.transform = originalTransform;
                wrapper.style.position = originalPosition;
                wrapper.style.left = originalLeft;
                wrapper.style.top = originalTop;
                
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('export-loading');
                }
                if (exportText) exportText.textContent = 'Export';
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
                
                state.isExporting = false;
            }
        }

        // Close color pickers when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-picker-popover') && !e.target.closest('button[onclick*="cp-"]')) {
                document.querySelectorAll('.color-picker-popover').forEach(popover => {
                    if (!popover.classList.contains('hidden')) {
                        popover.classList.add('hidden');
                    }
                });
            }
        });
        
        // Deep linking function for canvas double-click
        window.focusSidebarControl = function(id) {
            const el = document.getElementById(id);
            if (el) {
                // Ensure sidebar is open on mobile if applicable
                if (window.innerWidth <= 768) {
                    toggleSidebar(true);
                }
                
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight pulse
                el.classList.add('highlight-pulse');
                
                // Special handling for checkboxes/small inputs to highlight container
                if (el.type === 'checkbox') {
                    const parent = el.closest('div');
                    if (parent) parent.classList.add('highlight-pulse');
                    setTimeout(() => {
                        if (parent) parent.classList.remove('highlight-pulse');
                    }, 2000);
                }

                setTimeout(() => {
                    el.classList.remove('highlight-pulse');
                }, 2000);
            }
        };

        // Mobile Toggle Sidebar Function
        function toggleMobileSidebar() {
            var sidebar = document.querySelector("#sidebar");
            var container = document.querySelector(".my-container");
            
            if (sidebar && container) {
                sidebar.classList.toggle("active-nav");
                container.classList.toggle("active-cont");
                
                // Prevent body scroll when sidebar is open
                if (sidebar.classList.contains("active-nav")) {
                    document.body.classList.add("sidebar-open");
                } else {
                    document.body.classList.remove("sidebar-open");
                }
            }
        }
        
        // Collapsible Sidebar Functionality
        var menu_btn = document.querySelector("#menu-btn");
        var sidebar = document.querySelector("#sidebar");
        var container = document.querySelector(".my-container");
        
        if (sidebar && container) {
            // On mobile, start with sidebar hidden
            if (window.innerWidth <= 768) {
                sidebar.classList.remove("active-nav");
                container.classList.remove("active-cont");
            }
            
            // Desktop menu button handler
            if (menu_btn) {
                menu_btn.addEventListener("click", () => {
                    sidebar.classList.toggle("active-nav");
                    container.classList.toggle("active-cont");
                    
                    // On mobile, prevent body scroll when sidebar is open
                    if (window.innerWidth <= 768) {
                        if (sidebar.classList.contains("active-nav")) {
                            document.body.classList.add("sidebar-open");
                        } else {
                            document.body.classList.remove("sidebar-open");
                        }
                    }
                });
            }
            
            // Handle window resize
            window.addEventListener("resize", () => {
                if (window.innerWidth <= 768) {
                    // On mobile, ensure sidebar can be toggled
                    if (!sidebar.classList.contains("active-nav")) {
                        container.classList.remove("active-cont");
                    }
                } else {
                    // On desktop, restore normal behavior
                    document.body.classList.remove("sidebar-open");
                }
            });
        }

        // ── CONTEXTUAL TOOLBAR ENGINE ──────────────────────────────────────────

        (function initCtxToolbar() {
            const toolbar = document.getElementById('ctx-toolbar');
            let currentCtx = null;
            let currentAnchorEl = null;

            // ────────────────────────────────────────────────────
            //  TOOLBAR BUILDER DISPATCHER
            // ────────────────────────────────────────────────────
            function buildToolbar(ctxType, anchorEl) {

                toolbar.innerHTML = '';
                currentCtx = ctxType;
                currentAnchorEl = anchorEl;

                const builders = {
                    'background':      buildBackgroundToolbar,
                    'circle-overlay':  buildCircleOverlayToolbar,
                    'watermark':       buildWatermarkToolbar,
                    'logo':            buildLogoToolbar,
                    'headline':        buildHeadlineToolbar,
                    'caption':         buildCaptionToolbar,
                    'badge':           buildBadgeToolbar,
                    'swipe-left':      buildSwipeLeftToolbar,
                    'source':          buildSourceToolbar,
                    'highlight-ring':  buildHighlightRingToolbar,
                    'highlight-icon':  buildHighlightIconToolbar,
                    'brand':           buildBrandToolbar,
                };

                if (!builders[ctxType]) return;
                builders[ctxType]();

                // Hide if empty (e.g. caption only has inline edit)
                if (toolbar.children.length === 0) {
                    toolbar.classList.remove('visible');
                    return;
                }

                positionToolbar(anchorEl);
                toolbar.classList.add('visible');
            }

            // ────────────────────────────────────────────────────
            //  POSITIONING
            // ────────────────────────────────────────────────────
            function positionToolbar(anchorEl) {
                const anchorRect = anchorEl.getBoundingClientRect();
                const GAP = 10;
                const SCREEN_PAD = 12;

                // Toolbar is position:fixed at body level — use raw viewport coords
                const anchorCenterX = anchorRect.left + anchorRect.width / 2;

                // Temporarily make invisible (not display:none – we need it laid out to measure)
                toolbar.style.visibility = 'hidden';
                toolbar.classList.add('visible'); // adds display:flex via CSS

                requestAnimationFrame(() => {
                    const tbRect = toolbar.getBoundingClientRect();

                    // ── Horizontal clamping ──────────────────────────
                    const minX = SCREEN_PAD + tbRect.width / 2;
                    const maxX = window.innerWidth - SCREEN_PAD - tbRect.width / 2;
                    const clampedX = Math.max(minX, Math.min(maxX, anchorCenterX));

                    // left = center point minus half-width (translateX(-50%) is still applied in CSS)
                    // Actually we set left directly and remove the CSS transform for fixed elements
                    const finalLeft = clampedX - tbRect.width / 2;

                    // ── Vertical: prefer above, flip below if needed ─
                    let finalTop = anchorRect.top - tbRect.height - GAP;
                    if (finalTop < SCREEN_PAD) {
                        finalTop = anchorRect.bottom + GAP;
                    }
                    // Keep bottom edge on screen too
                    const maxTop = window.innerHeight - tbRect.height - SCREEN_PAD;
                    finalTop = Math.min(finalTop, maxTop);

                    toolbar.style.left       = finalLeft + 'px';
                    toolbar.style.top        = finalTop  + 'px';
                    toolbar.style.visibility = 'visible';
                });
            }

            function reanchor() {
                if (!currentCtx || !currentAnchorEl) return;
                setTimeout(() => {
                    const el = document.querySelector(`[data-ctx="${currentCtx}"]`);
                    if (el && toolbar.classList.contains('visible')) {
                        currentAnchorEl = el;
                        positionToolbar(el);
                    }
                }, 130);
            }

            function hideToolbar() {
                toolbar.classList.remove('visible');
                // Clear inline styles set by positionToolbar so CSS display:none takes effect
                toolbar.style.display = '';
                toolbar.style.visibility = '';
                currentCtx = null;
                currentAnchorEl = null;
            }

            // ────────────────────────────────────────────────────
            //  INLINE EDITING HELPER
            // ────────────────────────────────────────────────────
            function activateInlineEdit(el, initialValue, onUpdateState) {
                if (el.isContentEditable) return;

                el.contentEditable = true;
                el.classList.add('ctx-editing');
                
                // Show raw text for editing (removes HTML formatting like spans)
                el.innerText = initialValue;
                el.focus();

                // Select all text to avoid cursor mismatch with raw vs html
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);

                const onInput = (e) => {
                    e.stopPropagation();
                    onUpdateState(el.innerText);
                };

                const onBlur = () => {
                    el.contentEditable = false;
                    el.classList.remove('ctx-editing');
                    // Cleanup
                    el.removeEventListener('input', onInput);
                    el.removeEventListener('blur', onBlur);
                    el.removeEventListener('keydown', onKeydown);
                    el.removeEventListener('click', onClick);
                    // Re-render to restore formatting
                    renderCanvas(); 
                };

                const onKeydown = (e) => {
                    e.stopPropagation();
                    // Optional: Blur on Enter for single-line? 
                    // Let's allow multiline for now as users might want it.
                };

                const onClick = (e) => {
                    e.stopPropagation();
                };

                el.addEventListener('input', onInput);
                el.addEventListener('blur', onBlur);
                el.addEventListener('keydown', onKeydown); // prevent app hotkeys
                el.addEventListener('click', onClick); // prevent re-triggering toolbar build
            }

            // ────────────────────────────────────────────────────
            //  PRIMITIVE HELPERS
            // ────────────────────────────────────────────────────
            function addLabel(text) {
                if (!text) return;
                const el = document.createElement('span');
                el.className = 'ctx-label';
                el.textContent = text;
                toolbar.appendChild(el);
            }
            function addSep() {
                const el = document.createElement('div');
                el.className = 'ctx-sep';
                toolbar.appendChild(el);
            }
            function addBtn(html, onClick, active = false) {
                const btn = document.createElement('button');
                btn.className = 'ctx-btn' + (active ? ' active' : '');
                btn.innerHTML = html;
                btn.onclick = e => { e.stopPropagation(); onClick(); };
                toolbar.appendChild(btn);
                return btn;
            }

            // Single Color Picker Button (Cleaner, less overwhelming)
            function addColorPicker(currentColor, onChange) {
                const wrap = document.createElement('div');
                wrap.className = 'ctx-color-wrap';
                
                const btn = document.createElement('button');
                btn.className = 'ctx-btn';
                btn.title = 'Change Color';
                // Show a small preview dot and text
                btn.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${currentColor};border:1px solid rgba(255,255,255,0.4);display:inline-block;"></span> Color`;
                
                const inp = document.createElement('input');
                inp.type = 'color';
                inp.value = currentColor;
                inp.oninput = e => { 
                    e.stopPropagation(); 
                    // Live update the little preview dot
                    btn.querySelector('span').style.backgroundColor = e.target.value;
                    onChange(e.target.value); 
                };
                
                wrap.appendChild(btn);
                wrap.appendChild(inp);
                toolbar.appendChild(wrap);
            }

            // Slider with live value display
            function addSlider(label, min, max, step, value, unit, onChange) {
                if (label) addLabel(label);
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.className = 'ctx-slider';
                slider.min = min; slider.max = max; slider.step = step;
                slider.value = value;
                const valEl = document.createElement('span');
                valEl.className = 'ctx-val';
                valEl.textContent = fmtVal(value, unit);
                slider.oninput = e => {
                    e.stopPropagation();
                    const v = parseFloat(e.target.value);
                    valEl.textContent = fmtVal(v, unit);
                    onChange(v);
                };
                toolbar.appendChild(slider);
                toolbar.appendChild(valEl);
            }
            function fmtVal(v, unit) {
                if (unit === '%01') return Math.round(v * 100) + '%';
                if (unit === 'px')  return Math.round(v) + 'px';
                if (unit === '%')   return Math.round(v) + '%';
                return Math.round(v * 10) / 10;
            }



            // Image upload/replace button
            function addImageReplace(onLoad) {
                const lbl = document.createElement('label');
                lbl.className = 'ctx-img-label';
                // Inline SVG to ensure it always renders immediately without waiting for Lucide
                lbl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg> Replace';
                const fileInp = document.createElement('input');
                fileInp.type = 'file';
                fileInp.accept = 'image/*';
                fileInp.style.display = 'none';
                fileInp.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = re => onLoad(re.result);
                    reader.readAsDataURL(file);
                };
                lbl.appendChild(fileInp);
                toolbar.appendChild(lbl);
            }

            // ────────────────────────────────────────────────────
            //  PER-ELEMENT TOOLBARS
            // ────────────────────────────────────────────────────

            // Background image → Replace | Opacity | Zoom  (template-aware)
            function buildBackgroundToolbar() {
                const tmpl = state.post.template;

                if (tmpl === 'template2') {
                    const t2 = state.post.t2;
                    addImageReplace(dataUrl => { t2.bgImage = dataUrl; debouncedRenderCanvas(); reanchor(); });
                    addSep();
                    addSlider('Zoom', 100, 250, 5, t2.imageScale, '%', v => updateT2State('imageScale', v));
                    addSlider('Pos X', 0, 100, 1, t2.imagePosX, '%', v => updateT2State('imagePosX', v));
                    addSlider('Pos Y', 0, 100, 1, t2.imagePosY, '%', v => updateT2State('imagePosY', v));
                    return;
                }

                if (tmpl === 'template3') {
                    const t3 = state.post.t3;
                    addImageReplace(dataUrl => { t3.bgImage = dataUrl; debouncedRenderCanvas(); reanchor(); });
                    addSep();
                    addSlider('Zoom', 100, 250, 5, t3.imageScale, '%', v => updateT3State('imageScale', v));
                    addSlider('Pos X', 0, 100, 1, t3.imagePosX, '%', v => updateT3State('imagePosX', v));
                    addSlider('Pos Y', 0, 100, 1, t3.imagePosY, '%', v => updateT3State('imagePosY', v));
                    return;
                }

                // template1 default
                const s = state.post.style;
                addImageReplace(dataUrl => {
                    state.post.bgImage = dataUrl;
                    debouncedRenderCanvas();
                    reanchor();
                });
                addSep();
                addSlider('Opacity', 0, 1, 0.05, s.bgOpacity, '%01', v => updatePostStyle('bgOpacity', v));
                addSep();
                addSlider('Zoom', 100, 250, 5, s.imageScale, '%', v => updatePostStyle('imageScale', v));
            }

            // Circle overlay → Replace | Border color | Border px | Size | Hide
            function buildCircleOverlayToolbar() {
                const s = state.post.style;
                const isHidden = s.showOverlay === false;
                
                addImageReplace(dataUrl => {
                    updatePostStyle('overlayImgUrl', dataUrl);
                    reanchor();
                });
                addSep();
                addLabel('Border');
                addColorPicker(s.overlayBorderColor, c => { updatePostStyle('overlayBorderColor', c); reanchor(); });
                addSep();
                addSlider('Size', 100, 800, 10, s.overlayImgSize, 'px', v => { updatePostStyle('overlayImgSize', v); reanchor(); });
                addSlider('W', 0, 60, 1, s.overlayBorderWidth, 'px', v => { updatePostStyle('overlayBorderWidth', v); reanchor(); });
                
                addSep();
                addBtn(isHidden ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showOverlay', isHidden);
                    reanchor();
                });
            }

            // Watermark → Replace | Opacity | Size | Hide  (template-aware)
            function buildWatermarkToolbar() {
                const tmpl = state.post.template;

                if (tmpl === 'template2') {
                    const t2 = state.post.t2;
                    addImageReplace(dataUrl => { updateT2State('watermarkUrl', dataUrl); reanchor(); });
                    addSep();
                    addSlider('Opacity', 0, 1, 0.05, t2.watermarkOpacity, '%01', v => updateT2State('watermarkOpacity', v));
                    addSlider('Size', 50, 500, 10, t2.watermarkSize, 'px', v => updateT2State('watermarkSize', v));
                    addSep();
                    addBtn(!t2.showWatermark ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                        updateT2State('showWatermark', !t2.showWatermark);
                        reanchor();
                    });
                    return;
                }

                // template1 default
                const s = state.post.style;
                const isHidden = s.showWatermark === false;
                
                addImageReplace(dataUrl => {
                    updatePostStyle('watermarkUrl', dataUrl);
                    reanchor();
                });
                addSep();
                addSlider('Opacity', 0, 1, 0.05, s.watermarkOpacity, '%01', v => updatePostStyle('watermarkOpacity', v));
                addSlider('Size', 50, 500, 10, s.watermarkSize, 'px', v => updatePostStyle('watermarkSize', v));
                
                addSep();
                addBtn(!s.showWatermark ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showWatermark', !s.showWatermark);
                    reanchor();
                });
            }

            // Logo → Replace | Opacity | Size | Hide
            function buildLogoToolbar() {
                const s = state.post.style;
                const isHidden = s.showLogo === false;
                
                addImageReplace(dataUrl => {
                    updatePostStyle('logoUrl', dataUrl);
                    reanchor();
                });
                addSep();
                addSlider('Opacity', 0, 1, 0.05, s.logoOpacity, '%01', v => updatePostStyle('logoOpacity', v));
                addSlider('Size', 50, 400, 5, s.logoSize, 'px', v => updatePostStyle('logoSize', v));
                
                addSep();
                addBtn(isHidden ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showLogo', isHidden);
                    reanchor();
                });
            }

            // Headline → Edit text | Color | Size  (template-aware)
            function buildHeadlineToolbar() {
                const tmpl = state.post.template;

                if (tmpl === 'template2') {
                    const t2 = state.post.t2;
                    activateInlineEdit(currentAnchorEl, t2.headline, v => { t2.headline = v; });
                    addSep();
                    addSlider('Size', 30, 160, 2, t2.fontSize, 'px', v => updateT2State('fontSize', v));
                    return;
                }

                if (tmpl === 'template3') {
                    const t3 = state.post.t3;
                    activateInlineEdit(currentAnchorEl, t3.headline, v => { t3.headline = v; });
                    addSep();
                    addLabel('Color');
                    addColorPicker(t3.headlineColor, c => updateT3State('headlineColor', c));
                    addSep();
                    addSlider('Size', 30, 160, 2, t3.fontSize, 'px', v => updateT3State('fontSize', v));
                    return;
                }

                // template1 default
                const s = state.post.style;
                activateInlineEdit(currentAnchorEl, state.post.headline, v => {
                    state.post.headline = v;
                });

                addSep();
                addLabel('Text');
                addColorPicker(s.primaryColor, c => updatePostStyle('primaryColor', c));
                
                addSep();
                addLabel('[ ]');
                addColorPicker(s.highlightColor, c => updatePostStyle('highlightColor', c));
                
                addSep();
                addLabel('{ }');
                addColorPicker(s.secondaryColor, c => updatePostStyle('secondaryColor', c));
                
                addSep();
                addSlider('Size', 40, 160, 2, s.fontSize, 'px', v => updatePostStyle('fontSize', v));
            }

            // Caption → Edit text | (nothing else, keep it simple)
            function buildCaptionToolbar() {
                activateInlineEdit(currentAnchorEl, state.post.caption, v => {
                    state.post.caption = v;
                });
            }

            // News Badge → Edit text | Hide
            function buildBadgeToolbar() {
                const s = state.post.style;
                // Target the inner span to preserve the pill background/styling
                const editTarget = currentAnchorEl.querySelector('span') || currentAnchorEl;
                
                activateInlineEdit(editTarget, s.badgeText, v => {
                    s.badgeText = v; 
                });
                
                addSep();
                addBtn(!s.showNewsBadge ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showNewsBadge', !s.showNewsBadge);
                    reanchor();
                });
            }

            // Swipe Left → Toggle off
            function buildSwipeLeftToolbar() {
                const s = state.post.style;
                addLabel('Swipe Indicator');
                addSep();
                addBtn(!s.showSwipeBadge ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showSwipeBadge', !s.showSwipeBadge);
                    reanchor();
                });
            }

            // Source/credit → Edit text | Hide
            function buildSourceToolbar() {
                const s = state.post.style;
                activateInlineEdit(currentAnchorEl, s.sourceText, v => {
                    s.sourceText = v;
                });

                addSep();
                addBtn(!s.showSource ? '<i class="bx bx-show"></i> Show' : '<i class="bx bx-hide"></i> Hide', () => {
                    updatePostStyle('showSource', !s.showSource);
                    reanchor();
                });
            }

            // Brand divider (template3) → Color | Size | Show/Hide letter
            function buildBrandToolbar() {
                const t3 = state.post.t3;
                addLabel('Brand');
                addColorPicker(t3.brandColor, c => updateT3State('brandColor', c));
                addSep();
                addSlider('Size', 16, 80, 1, t3.brandSize, 'px', v => updateT3State('brandSize', v));
                addSep();
                addBtn(t3.showBrandLetter !== false ? '<i class="bx bx-hide"></i> Hide Letter' : '<i class="bx bx-show"></i> Show Letter', () => {
                    updateT3State('showBrandLetter', t3.showBrandLetter === false);
                    reanchor();
                });
            }

            // Highlight ring → Color | Thickness
            function buildHighlightRingToolbar() {
                const h = state.highlight;
                addLabel('Ring');
                addColorPicker(h.ringColor, c => updateHighlightState('ringColor', c));
                addSep();
                addSlider('Thick', 0, 100, 2, h.ringWidth, 'px', v => updateHighlightState('ringWidth', v));
            }

            // Highlight icon → Color | Size
            function buildHighlightIconToolbar() {
                const h = state.highlight;
                addLabel('Icon');
                addColorPicker(h.iconColor, c => updateHighlightState('iconColor', c));
                addSep();
                addSlider('Size', 100, 800, 20, h.iconSize, 'px', v => updateHighlightState('iconSize', v));
            }

            // ────────────────────────────────────────────────────
            //  CLICK DELEGATION
            // ────────────────────────────────────────────────────
            // Single capture-phase listener handles everything.
            // Capture phase fires before any inline onclick/stopPropagation on children.
            document.addEventListener('click', e => {
                // Post Generator only
                if (state.mode !== 'post') { hideToolbar(); return; }

                // Clicks inside the toolbar itself → do nothing
                if (toolbar.contains(e.target)) return;

                // Check if a ctx-enabled element was clicked
                const target = e.target.closest('[data-ctx]');
                if (target) {
                    buildToolbar(target.getAttribute('data-ctx'), target);
                    return;
                }

                // Everything else → hide
                hideToolbar();
            }, true); // true = capture phase

            // Also hide toolbar when switching away from Post mode
            const _origSetMode = window.setMode;
            window.setMode = function(mode) {
                hideToolbar();
                if (_origSetMode) _origSetMode(mode);
            };

        })();

    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
</body>
</html>